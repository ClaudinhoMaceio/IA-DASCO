<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Dasco - Sistema Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        :root { --dasco-blue: #1d438a; --dasco-red: #e30613; }
        .chat-container { height: calc(100vh - 220px); overflow-y: auto; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }

        .message-dasco {
            background: white;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            animation: slideUp 0.3s ease-out;
            border: 1px solid #e2e8f0;
        }
        .message-user {
            background: var(--dasco-blue);
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
            animation: slideInRight 0.2s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        .option-btn { border: 1px solid #e2e8f0; background: white; color: var(--dasco-blue); transition: all 0.2s; font-weight: 600; }
        .option-btn:hover { border-color: var(--dasco-blue); background: #eff6ff; transform: translateY(-1px); }

        .admin-card { 
            background: white;
            border-radius: 20px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); 
            transition: all 0.3s;
            animation: fadeInScale 0.5s ease-out;
        }
        .admin-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .gear-icon {
            animation: rotate 3s linear infinite;
            cursor: pointer;
        }
        .gear-icon:hover {
            animation-duration: 0.5s;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .json-file-item {
            transition: all 0.2s;
        }
        .json-file-item:hover {
            transform: translateX(5px);
            border-color: var(--dasco-blue) !important;
        }

        .voice-pulse {
            animation: pulse-red 1.5s infinite;
            background: var(--dasco-red) !important;
            color: white !important;
        }
        
        @keyframes pulse-red {
            0% { 
                box-shadow: 0 0 0 0 rgba(227, 6, 19, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(227, 6, 19, 0);
                transform: scale(1.1);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(227, 6, 19, 0);
                transform: scale(1);
            }
        }

        /* Anima√ß√£o de Apresenta√ß√£o Dasco */
        #splashScreen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #1d438a 0%, #2563eb 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            animation: fadeOut 0.5s ease-out 2.5s forwards;
        }

        .dasco-logo-container {
            animation: logoAnimation 2s ease-out;
        }

        .dasco-text {
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textGlow 2s ease-in-out infinite alternate;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .dasco-subtitle {
            font-size: 1rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 1s forwards;
            margin-top: 1rem;
        }

        @keyframes logoAnimation {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(50px);
            }
            50% {
                transform: scale(1.1) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes textGlow {
            0% {
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
            }
            100% {
                filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.6));
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            margin-top: 2rem;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 1.5s forwards;
        }

        .loading-dots span {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Anima√ß√µes Modernas para Dashboard */
        .stat-card {
            animation: slideInFromBottom 0.6s ease-out;
            animation-fill-mode: both;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .stat-card:hover::before {
            left: 100%;
        }
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }
        .stat-card:nth-child(6) { animation-delay: 0.6s; }
        .stat-card:nth-child(7) { animation-delay: 0.7s; }
        .stat-card:nth-child(8) { animation-delay: 0.8s; }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chart-container {
            animation: fadeInScale 0.8s ease-out;
            transition: all 0.3s;
        }
        .chart-container:hover {
            transform: scale(1.01);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes numberCount {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .stat-number {
            animation: numberCount 0.8s ease-out;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Overlay de Login Dashboard -->
    <div id="dashboardLoginOverlay" class="bg-slate-900/95 hidden backdrop-blur-xl fixed inset-0 z-[1000] flex items-center justify-center">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-md shadow-2xl border border-slate-100">
            <div class="flex justify-center mb-6">
                <div class="text-[#1d438a] font-black text-xl">DASCO</div>
        </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2 text-center">Acesso ao Dashboard</h3>
            <p class="text-slate-400 text-center text-sm mb-8">Insira a senha de administrador</p>
            <div class="space-y-5">
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1">Senha</label>
                    <input type="password" id="dashboardPassword" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key === 'Enter') checkDashboardPassword()">
                </div>
                <button onclick="checkDashboardPassword()" class="w-full bg-[#1d438a] text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-blue-800 transition-all active:scale-95 mt-4">
                    Acessar Dashboard
        </button>
                <button onclick="hideDashboardLogin()" class="w-full text-slate-400 py-2 text-xs font-semibold hover:text-slate-600 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Tela de Apresenta√ß√£o Dasco -->
    <div id="splashScreen">
        <div class="dasco-logo-container">
            <div class="bg-white p-6 rounded-3xl mb-8 shadow-2xl">
                <div class="text-[#1d438a] font-black text-5xl">DASCO</div>
            </div>
            <h1 class="dasco-text">DASCO</h1>
            <p class="dasco-subtitle">Intelig√™ncia Conectada</p>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>


    <!-- Interface Principal -->
    <div id="mainInterface" class="flex flex-col h-full hidden">

    <!-- Header -->
        <header class="bg-white p-4 flex items-center justify-between border-b border-slate-200 shadow-sm z-10">
            <div class="flex items-center space-x-3">
                <div class="p-1.5 bg-slate-50 rounded-xl border border-slate-100">
                    <div class="bg-[#1d438a] text-white p-1 rounded font-bold text-[10px]">DS</div>
            </div>
            <div>
                    <h1 id="viewTitle" class="font-bold text-slate-800 text-sm md:text-base leading-tight">Intelig√™ncia Dasco</h1>
                    <div class="flex items-center space-x-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">Sistema Ativo</span>
            </div>
        </div>
            </div>
            <div class="flex items-center space-x-2">
                <!-- √çcone de Engrenagem para Acesso Admin -->
                <button onclick="showDashboardLogin()" class="p-2 bg-slate-100 text-slate-500 rounded-xl hover:bg-blue-50 hover:text-blue-600 transition-all gear-icon" title="Acesso ao Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
                <div class="flex items-center space-x-2">
                    <button onclick="switchView('chat')" class="px-4 py-2 bg-slate-50 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest border border-slate-100 hover:bg-slate-100 transition-colors">Chat</button>
                </div>
            </div>
    </header>

        <!-- Container de Visualiza√ß√£o -->
        <div id="contentView" class="flex-1 overflow-hidden relative">
            
            <!-- Chat View (Sempre vis√≠vel por padr√£o) -->
            <div id="chatView" class="h-full flex flex-col bg-slate-50/50">
                <main id="chatWindow" class="chat-container flex flex-col p-6 space-y-4"></main>
                <footer class="p-4 bg-white border-t border-slate-100 shadow-[0_-4px_10px_rgba(0,0,0,0.02)]">
        <div class="max-w-3xl mx-auto flex items-end space-x-3">
            <div class="flex-1 relative">
                            <textarea id="userInput" rows="1" class="w-full p-4 pr-12 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-200 outline-none resize-none text-sm transition-all" placeholder="Responda por aqui..."></textarea>
                            <button id="micBtn" onclick="toggleVoiceRecognition()" class="absolute right-3 bottom-3 p-1.5 text-slate-400 hover:text-dasco-red transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg></button>
            </div>
                        <button onclick="processInput()" class="bg-[#1d438a] text-white p-4 rounded-2xl shadow-lg hover:shadow-blue-200 active:scale-90 transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7" /></svg></button>
        </div>
    </footer>
            </div>

            <!-- Dashboard View (Oculto por padr√£o - s√≥ aparece ap√≥s login admin) -->
            <div id="dashboardView" class="h-full overflow-y-auto p-6 hidden space-y-6 bg-gradient-to-br from-slate-50 to-blue-50/30">
                <!-- Aviso de Modo file:// -->
                <div id="fileProtocolWarning" class="hidden bg-red-500 text-white p-6 rounded-2xl shadow-2xl border-4 border-red-600 animate-pulse">
                    <div class="flex items-start space-x-4">
                        <div class="text-4xl">‚ö†Ô∏è</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-black mb-2 uppercase tracking-wide">SINCRONIZA√á√ÉO BLOQUEADA</h3>
                            <p class="text-sm font-semibold mb-3">Voc√™ est√° abrindo o arquivo diretamente (file://). A sincroniza√ß√£o com Google Drive N√ÉO funciona neste modo!</p>
                            <div class="bg-white/20 p-4 rounded-xl mb-3">
                                <p class="font-bold text-base mb-2">üìå SOLU√á√ÉO OBRIGAT√ìRIA:</p>
                                <ol class="list-decimal list-inside space-y-2 text-sm">
                                    <li>Instale a extens√£o <strong>"Live Server"</strong> no VS Code</li>
                                    <li>Clique com bot√£o direito no arquivo <strong>index.html</strong></li>
                                    <li>Selecione <strong>"Open with Live Server"</strong></li>
                                    <li>O navegador abrir√° em <strong>http://localhost</strong> e a sincroniza√ß√£o funcionar√°!</li>
                                </ol>
                            </div>
                            <p class="text-xs opacity-90 italic">üí° Sem Live Server, o dashboard n√£o consegue carregar dados do Google Drive devido a restri√ß√µes de seguran√ßa do navegador.</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 tracking-tight">Dashboard Administrativo</h2>
                        <p class="text-xs text-slate-400 font-medium mt-1">An√°lise em tempo real de todos os question√°rios</p>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                        <!-- Filtro por Cidade/Contrato -->
                        <select id="filterCidade" onchange="updateDashboard()" class="bg-white border-2 border-[#1d438a] text-slate-800 px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase shadow-lg hover:bg-blue-50 transition-all focus:outline-none focus:ring-2 focus:ring-[#1d438a]">
                            <option value="">üìç Todas as Cidades</option>
                            <option value="Itatiba">Itatiba</option>
                            <option value="Itupeva">Itupeva</option>
                            <option value="Morungaba">Morungaba</option>
                            <option value="Jarinu">Jarinu</option>
                            <option value="Campo Limpo">Campo Limpo</option>
                            <option value="V√°rzea Paulista">V√°rzea Paulista</option>
                            <option value="Cabre√∫va">Cabre√∫va</option>
                        </select>
                    </div>
                    <div class="flex space-x-2 w-full md:w-auto">
                        <button onclick="syncGoogleDrive()" class="flex-1 md:flex-none bg-[#1d438a] text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-[#153366] transition-all" id="syncBtn">
                            <span id="syncBtnText">üîÑ Sincronizar Google Drive</span>
                </button>
                        <button onclick="refreshData()" class="flex-1 md:flex-none bg-[#1d438a] text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-[#153366] transition-all">
                            üîÑ Atualizar
                        </button>
                        <button onclick="exportPDF()" class="flex-1 md:flex-none bg-[#1d438a] text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-[#153366] transition-all">üìÑ Exportar PDF</button>
                        <button onclick="exportExcel()" class="flex-1 md:flex-none bg-[#1d438a] text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-[#153366] transition-all">üìä Exportar Excel</button>
            </div>
                </div>


                <!-- Cards de Estat√≠sticas Animados - Expandido -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="admin-card stat-card p-6 border-l-4 border-blue-600 bg-gradient-to-br from-blue-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Participa√ß√µes</p>
                            <span class="p-2 bg-blue-100 text-blue-600 rounded-xl text-xl shadow-sm">üìä</span>
                        </div>
                        <h4 id="totalFeedbacks" class="text-5xl font-bold text-slate-800 stat-number">0</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Question√°rios respondidos</p>
                        <div class="mt-3 h-1 bg-blue-100 rounded-full overflow-hidden">
                            <div id="totalProgress" class="h-full bg-blue-600 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="admin-card stat-card p-6 border-l-4 border-green-500 bg-gradient-to-br from-green-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">N√≠vel de Orgulho</p>
                            <span class="p-2 bg-green-100 text-green-600 rounded-xl text-xl shadow-sm">üíô</span>
                        </div>
                        <h4 id="prideScore" class="text-5xl font-bold text-slate-800 stat-number">--</h4>
                        <p class="text-[9px] text-slate-500 mt-2">M√©dia geral de satisfa√ß√£o</p>
                        <div class="mt-3 flex items-center gap-2">
                            <div class="flex-1 h-2 bg-green-100 rounded-full overflow-hidden">
                                <div id="prideProgress" class="h-full bg-green-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                            <span id="pridePercent" class="text-[10px] font-bold text-green-600">0%</span>
                        </div>
                    </div>
                    <div class="admin-card stat-card p-6 border-l-4 border-amber-500 bg-gradient-to-br from-amber-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status Seguran√ßa</p>
                            <span class="p-2 bg-amber-100 text-amber-600 rounded-xl text-xl shadow-sm">üõ°Ô∏è</span>
                        </div>
                        <h4 id="safetyAlert" class="text-5xl font-bold text-slate-800 stat-number">OK</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Avalia√ß√£o de seguran√ßa</p>
                        <div class="mt-3">
                            <span id="safetyPercent" class="text-[10px] font-bold text-amber-600">0% positivo</span>
                        </div>
                    </div>
                    <div class="admin-card stat-card p-6 border-l-4 border-[#1d438a] bg-gradient-to-br from-blue-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lideran√ßa</p>
                            <span class="p-2 bg-blue-100 text-[#1d438a] rounded-xl text-xl shadow-sm">‚≠ê</span>
                        </div>
                        <h4 id="leadershipScore" class="text-5xl font-bold text-slate-800 stat-number">--</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Avalia√ß√£o de lideran√ßa</p>
                        <div class="mt-3 flex items-center gap-2">
                            <div class="flex-1 h-2 bg-blue-100 rounded-full overflow-hidden">
                                <div id="leadershipProgress" class="h-full bg-[#1d438a] rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                            <span id="leadershipPercent" class="text-[10px] font-bold text-[#1d438a]">0/5</span>
                        </div>
                    </div>
                </div>
                
                <!-- Segunda Linha de Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="admin-card stat-card p-6 border-l-4 border-purple-500 bg-gradient-to-br from-purple-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sugest√µes</p>
                            <span class="p-2 bg-purple-100 text-purple-600 rounded-xl text-xl shadow-sm">üí°</span>
                        </div>
                        <h4 id="suggestionsCount" class="text-5xl font-bold text-slate-800 stat-number">0</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Melhorias sugeridas</p>
                    </div>
                    <div class="admin-card stat-card p-6 border-l-4 border-indigo-500 bg-gradient-to-br from-indigo-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Cidades Ativas</p>
                            <span class="p-2 bg-indigo-100 text-indigo-600 rounded-xl text-xl shadow-sm">üèôÔ∏è</span>
                        </div>
                        <h4 id="citiesCount" class="text-5xl font-bold text-slate-800 stat-number">0</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Contratos participantes</p>
                    </div>
                    <div class="admin-card stat-card p-6 border-l-4 border-teal-500 bg-gradient-to-br from-teal-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Taxa Positiva</p>
                            <span class="p-2 bg-teal-100 text-teal-600 rounded-xl text-xl shadow-sm">üìà</span>
                        </div>
                        <h4 id="positiveRate" class="text-5xl font-bold text-slate-800 stat-number">0%</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Avalia√ß√µes positivas</p>
                    </div>
                    <div class="admin-card stat-card p-6 border-l-4 border-rose-500 bg-gradient-to-br from-rose-50 to-white">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">√öltima Atualiza√ß√£o</p>
                            <span class="p-2 bg-rose-100 text-rose-600 rounded-xl text-xl shadow-sm">üïê</span>
                        </div>
                        <h4 id="lastUpdate" class="text-3xl font-bold text-slate-800 stat-number">--</h4>
                        <p class="text-[9px] text-slate-500 mt-2">√öltima sincroniza√ß√£o</p>
                    </div>
                </div>

                <!-- Gr√°ficos Animados -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="admin-card chart-container p-8">
                        <h5 class="text-xs font-black text-slate-400 uppercase mb-6 tracking-widest">Engajamento por Categoria</h5>
                        <div class="relative h-[300px]">
                            <canvas id="engagementChart"></canvas>
                        </div>
                    </div>
                    <div class="admin-card chart-container p-8">
                        <h5 class="text-xs font-black text-slate-400 uppercase mb-6 tracking-widest">Evolu√ß√£o da Lideran√ßa</h5>
                        <div class="relative h-[300px]">
                            <canvas id="leadershipChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Distribui√ß√£o de Respostas -->
                <div class="admin-card chart-container p-8">
                    <h5 class="text-xs font-black text-slate-400 uppercase mb-6 tracking-widest">Distribui√ß√£o de Respostas por Quest√£o</h5>
                    <div class="relative h-[350px]">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>

                <!-- Lista Completa de Participa√ß√µes -->
                <div class="admin-card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">üìã Todas as Participa√ß√µes - Detalhes Completos</h5>
                        <span id="participacoesCount" class="bg-[#1d438a] text-white text-[10px] px-3 py-1.5 rounded-lg font-bold uppercase">0 Participa√ß√µes</span>
                    </div>
                    <div id="participacoesList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                        <div class="text-center py-10">
                            <p class="text-xs italic text-slate-400 font-medium tracking-wide">Carregando participa√ß√µes...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Sugest√µes -->
                <div class="admin-card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h5 class="text-xs font-black text-slate-700 uppercase tracking-widest">üí° Sugest√µes de Melhoria</h5>
                        <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-md font-bold uppercase pulse-animation">Recentes</span>
                    </div>
                    <div id="feedbackList" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                        <div class="text-center py-10">
                            <p class="text-xs italic text-slate-400 font-medium tracking-wide">Aguardando sugest√µes...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configura√ß√£o do Google Drive
        const GOOGLE_DRIVE_FOLDER_ID = '1cg0SPId-JFv0OqI5dVOCy9ReZBF6TIox'; // ID da pasta do Google Drive
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmd0ZNz4WBkSw2Axey9EeDT9Mr_6_vpbKvxTj12IlL0Zj-lOgxDrIHbXzlafJMOsS9/exec'; // URL do Google Apps Script
        const GOOGLE_DRIVE_SYNC_URL = 'https://script.google.com/macros/s/AKfycbzmd0ZNz4WBkSw2Axey9EeDT9Mr_6_vpbKvxTj12IlL0Zj-lOgxDrIHbXzlafJMOsS9/exec'; // URL para sincroniza√ß√£o (mesma do upload)
        
        const chatWindow = document.getElementById('chatWindow');
        const userInput = document.getElementById('userInput');
        let currentStep = 0;
        let userData = { timestamp: new Date().toISOString() };
        let mockDatabase = [];
        let jsonFiles = [];
        let charts = {};
        let lastSyncTime = null;
        let syncInterval = null;
        let isSpeaking = false;
        let speechQueue = [];
        let userInteracted = false;
        let onSpeechEndCallback = null; // Callback para quando a fala terminar

        // Di√°logo ser√° gerado dinamicamente com sauda√ß√£o baseada na hora
        function getDialogue() {
            const greeting = getGreeting();
            const dateTime = getFormattedDateTimeShort();
            
            return [
            {
                id: 'intro',
                    text: `${greeting}! Sou a intelig√™ncia artificial da **Dasco**. Hoje √© ${dateTime}. √â um prazer conversar com voc√™. Antes de iniciarmos nossa pesquisa de clima organizacional, gostaria de saber: qual √© o seu nome?`, 
                    speak: `${greeting}! Sou a intelig√™ncia artificial da Dasco. Hoje √© ${dateTime}. √â um prazer conversar com voc√™. Antes de iniciarmos nossa pesquisa de clima organizacional, gostaria de saber: qual √© o seu nome?`, 
                    type: 'open' 
                },
            { 
                id: 'sigilo', 
                text: "Muito obrigada, [NOME]! Gostaria de informar que esta pesquisa √© **completamente sigilosa e an√¥nima**. Seu nome n√£o ser√° utilizado em nenhum relat√≥rio ou an√°lise. Todas as respostas ser√£o tratadas com total confidencialidade. Podemos come√ßar?", 
                speak: "Muito obrigada! Gostaria de informar que esta pesquisa √© completamente sigilosa e an√¥nima. Seu nome n√£o ser√° utilizado em nenhum relat√≥rio ou an√°lise. Todas as respostas ser√£o tratadas com total confidencialidade. Podemos come√ßar?", 
                options: ["Sim, vamos come√ßar", "Agora n√£o"] 
            },
            {
                id: 'cidade',
                text: "Em qual cidade/contrato voc√™ trabalha?", 
                speak: "Em qual cidade ou contrato voc√™ trabalha?", 
                options: ["Itatiba", "Itupeva", "Morungaba", "Jarinu", "Campo Limpo", "V√°rzea Paulista", "Cabre√∫va"]
            },
            {
                id: 'orgulho',
                text: "Em uma escala de avalia√ß√£o, o quanto voc√™ sente **orgulho** de trabalhar na Dasco e contribuir com o saneamento da nossa regi√£o?", 
                speak: "Em uma escala de avalia√ß√£o, o quanto voc√™ sente orgulho de trabalhar na Dasco e contribuir com o saneamento da nossa regi√£o?", 
                options: ["Muito Orgulho üíô", "Orgulho", "Neutro", "Pouco Orgulho"]
            },
            {
                id: 'seguranca',
                text: "A Dasco oferece todas as condi√ß√µes e equipamentos de **seguran√ßa** necess√°rios para voc√™ realizar seu trabalho com tranquilidade?", 
                speak: "A Dasco oferece todas as condi√ß√µes e equipamentos de seguran√ßa necess√°rios para voc√™ realizar seu trabalho com tranquilidade?", 
                options: ["Sim, totalmente", "Na maioria", "Poderia melhorar", "N√£o"] 
            },
            {
                id: 'lideranca',
                text: "Como voc√™ avalia o suporte e a comunica√ß√£o da sua **lideran√ßa direta** quando voc√™ encontra um problema t√©cnico ou desafio no campo?", 
                speak: "Como voc√™ avalia o suporte e a comunica√ß√£o da sua lideran√ßa direta quando voc√™ encontra um problema t√©cnico ou desafio no campo?", 
                options: ["Excelente", "Bom", "Regular", "Insuficiente"]
            },
            {
                id: 'melhoria',
                text: "Por fim, se voc√™ pudesse sugerir uma **melhoria imediata** em algum processo, equipamento ou aspecto da Dasco, o que seria?", 
                speak: "Por fim, se voc√™ pudesse sugerir uma melhoria imediata em algum processo, equipamento ou aspecto da Dasco, o que seria?", 
                type: 'open'
            },
            {
                id: 'fim',
                text: "Muito obrigada pela sua participa√ß√£o, [NOME]! Seu feedback √© extremamente valioso para n√≥s e foi registrado com seguran√ßa no sistema Dasco. Tenha um excelente trabalho!", 
                speak: "Muito obrigada pela sua participa√ß√£o! Seu feedback √© extremamente valioso para n√≥s e foi registrado com seguran√ßa no sistema Dasco. Tenha um excelente trabalho!", 
                type: "end"
            }
        ];
        }

        // Vari√°vel dialogue que ser√° atualizada dinamicamente
        let dialogue = getDialogue();

        // Fun√ß√µes para data e hora
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) {
                return 'Bom dia';
            } else if (hour >= 12 && hour < 18) {
                return 'Boa tarde';
            } else {
                return 'Boa noite';
            }
        }

        function getFormattedDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                day: 'numeric',
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return now.toLocaleDateString('pt-BR', options);
        }

        function getFormattedDateTimeShort() {
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return `${date}, √†s ${time}`;
        }

        function getDateTimeForReport() {
            const now = new Date();
            return {
                data: now.toLocaleDateString('pt-BR'),
                hora: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: now.toISOString()
            };
        }

        let selectedVoice = null;
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                selectedVoice = voices.find(v => v.lang === 'pt-BR' && (v.name.includes('Google') || v.name.includes('Maria') || v.name.includes('Luciana'))) || voices.find(v => v.lang === 'pt-BR');
                console.log('Voz selecionada:', selectedVoice?.name || 'Nenhuma voz encontrada');
            }
        }

        // Configurar evento para carregar vozes quando dispon√≠veis
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speak(text, onEnd = null) {
            if (!text || text.trim() === '') {
                console.log('Texto vazio para falar');
                if (onEnd) onEnd();
                return;
            }
            
            // Se n√£o houve intera√ß√£o do usu√°rio ainda, adicionar √† fila
            if (!userInteracted) {
                console.log('Aguardando intera√ß√£o do usu√°rio antes de falar...');
                speechQueue.push({text, onEnd});
                return;
            }
            
            // Se j√° est√° falando, adicionar √† fila
            if (isSpeaking) {
                console.log('J√° est√° falando, adicionando √† fila:', text.substring(0, 50));
                speechQueue.push({text, onEnd});
                return;
            }
            
            console.log('Tentando falar:', text.substring(0, 50) + '...');
            
            // Garantir que as vozes estejam carregadas
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                if (!selectedVoice) {
                    selectedVoice = voices.find(v => v.lang === 'pt-BR' && (v.name.includes('Google') || v.name.includes('Maria') || v.name.includes('Luciana'))) || voices.find(v => v.lang === 'pt-BR');
                    console.log('Voz selecionada:', selectedVoice?.name || 'Nenhuma voz encontrada');
                }
            } else {
                console.log('Nenhuma voz dispon√≠vel ainda, tentando carregar...');
                loadVoices();
                // Tentar novamente ap√≥s um pequeno delay
                setTimeout(() => speak(text), 200);
                return;
            }
            
            isSpeaking = true;
            
            const u = new SpeechSynthesisUtterance(text);
            if (selectedVoice) {
                u.voice = selectedVoice;
            }
            u.lang = 'pt-BR';
            u.rate = 1.35; // Velocidade aumentada para n√£o atrapalhar a pesquisa - apenas direcionamento
            u.pitch = 1.0; // Tom mais neutro e profissional
            u.volume = 1.0; // Volume m√°ximo
            
            u.onstart = () => {
                console.log('Voz iniciada com sucesso!');
            };
            
            u.onend = () => {
                console.log('Fala conclu√≠da completamente');
                isSpeaking = false;
                
                // Aguardar delay m√≠nimo para garantir que a fala terminou
                // Delay reduzido para resposta mais r√°pida e sincronizada
                setTimeout(() => {
                    // Chamar callback se houver
                    if (onEnd) {
                        onEnd();
                    }
                    
                    // Processar pr√≥ximo item da fila rapidamente
                    if (speechQueue.length > 0) {
                        const nextItem = speechQueue.shift();
                        setTimeout(() => speak(nextItem.text, nextItem.onEnd), 50);
                    }
                }, 100); // Reduzido para resposta mais r√°pida
            };
            
            u.onerror = (e) => {
                // Ignorar erros de "interrupted" - s√£o normais quando o usu√°rio responde rapidamente
                if (e.error === 'interrupted') {
                    console.log('Fala interrompida (normal quando usu√°rio responde)');
                    isSpeaking = false;
                    // Chamar callback mesmo se interrompido
                    if (onEnd) {
                        onEnd();
                    }
                    return;
                }
                
                console.error('Erro ao falar:', e);
                isSpeaking = false;
                
                // Se for erro de permiss√£o, n√£o tentar novamente
                if (e.error === 'not-allowed') {
                    console.warn('S√≠ntese de voz n√£o permitida. O usu√°rio precisa interagir primeiro.');
                    speechQueue = []; // Limpar fila
                    return;
                }
                
                // Para outros erros, tentar pr√≥ximo item da fila
                if (speechQueue.length > 0) {
                    const nextItem = speechQueue.shift();
                    setTimeout(() => speak(nextItem.text, nextItem.onEnd), 50);
                } else if (onEnd) {
                    // Se n√£o h√° mais itens na fila, chamar callback
                    onEnd();
                }
            };
            
            // Falar imediatamente
            try {
                window.speechSynthesis.speak(u);
                console.log('Comando speak() executado');
            } catch (error) {
                console.error('Erro ao executar speak():', error);
                isSpeaking = false;
            }
        }

        function startExperience() {
            setTimeout(() => {
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('mainInterface').classList.remove('hidden');
                // Carregar di√°logo atualizado com sauda√ß√£o e data/hora
                dialogue = getDialogue();
                
                // Garantir que as vozes estejam carregadas antes de come√ßar
                loadVoices();
                
                // Aguardar um pouco mais para garantir que tudo est√° pronto
                setTimeout(() => {
                    // Recarregar vozes novamente para garantir
                    loadVoices();
                    
                    // Aguardar mais um pouco para garantir que as vozes foram carregadas
                    setTimeout(() => {
                        // Iniciar o primeiro passo (a fala s√≥ acontecer√° ap√≥s intera√ß√£o do usu√°rio)
                nextStep(); 
                        
                        // Se o usu√°rio j√° interagiu, falar imediatamente
                        if (userInteracted) {
                            const step = dialogue[0];
                            if (step && step.speak) {
                                setTimeout(() => speak(step.speak), 100);
                            }
                        }
                    }, 500);
                }, 500);
            }, 3000);
        }

        function showDashboardLogin() {
            document.getElementById('dashboardLoginOverlay').classList.remove('hidden');
        }

        function hideDashboardLogin() {
            document.getElementById('dashboardLoginOverlay').classList.add('hidden');
            document.getElementById('dashboardPassword').value = '';
        }

        function checkDashboardPassword() {
            const password = document.getElementById('dashboardPassword').value;
            if (password === 'dasco2029') {
                hideDashboardLogin();
                switchView('dashboard');
            } else {
                alert('Senha incorreta. Tente novamente.');
                document.getElementById('dashboardPassword').value = '';
            }
        }

        function switchView(view) {
            const isDash = view === 'dashboard';
            const chatView = document.getElementById('chatView');
            const dashboardView = document.getElementById('dashboardView');
            
            if (isDash) {
                chatView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                document.getElementById('viewTitle').innerText = "Painel de Gest√£o Dasco";
                
                // Verificar se est√° em modo file:// e mostrar aviso
                const isFileProtocol = window.location.protocol === 'file:';
                const fileProtocolWarning = document.getElementById('fileProtocolWarning');
                
                if (isFileProtocol) {
                    if (fileProtocolWarning) {
                        fileProtocolWarning.classList.remove('hidden');
                        console.error('‚ùå ============================================');
                        console.error('‚ùå SINCRONIZA√á√ÉO BLOQUEADA - MODO file://');
                        console.error('‚ùå ============================================');
                        console.error('üìå Para sincronizar com Google Drive, voc√™ DEVE usar Live Server!');
                        console.error('üìå Veja as instru√ß√µes no banner vermelho no topo do dashboard.');
                    }
                    // Mesmo em modo file://, atualizar dashboard com dados locais (se houver)
                    updateDashboard();
                } else {
                    if (fileProtocolWarning) {
                        fileProtocolWarning.classList.add('hidden');
                    }
                    // Limpar e recarregar tudo quando abrir o dashboard
                    console.log('üìä Dashboard aberto - limpando e recarregando dados...');
                    console.log('üóëÔ∏è Limpando mockDatabase e jsonFiles para recarregar do Google Drive');
                    mockDatabase = [];
                    jsonFiles = [];
                    
                    // Atualizar dashboard vazio primeiro
                    updateDashboard();
                    
                    // Iniciar sincroniza√ß√£o autom√°tica quando abrir o dashboard
                    startAutoSync();
                }
            } else {
                chatView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                document.getElementById('viewTitle').innerText = "Intelig√™ncia Dasco";
                // Parar sincroniza√ß√£o autom√°tica quando sair do dashboard
                stopAutoSync();
            }
        }

        // Fun√ß√£o para sincronizar arquivos do Google Drive
        async function syncGoogleDrive() {
            const syncUrl = GOOGLE_DRIVE_SYNC_URL || GOOGLE_APPS_SCRIPT_URL;
            
            if (!syncUrl) {
                alert('Google Drive n√£o configurado. Configure GOOGLE_DRIVE_SYNC_URL ou GOOGLE_APPS_SCRIPT_URL no c√≥digo.');
                return;
            }

            console.log('üîÑ ============================================');
            console.log('üîÑ INICIANDO SINCRONIZA√á√ÉO COM GOOGLE DRIVE');
            console.log('üîÑ ============================================');
            console.log('üì° URL do Script:', syncUrl);
            console.log('üìÅ ID da Pasta:', GOOGLE_DRIVE_FOLDER_ID);
            console.log('üåê Protocolo:', window.location.protocol);
            console.log('üìç URL Completa:', window.location.href);

            const syncBtn = document.getElementById('syncBtn');
            const syncBtnText = document.getElementById('syncBtnText');
            
            if (syncBtn) {
                syncBtn.disabled = true;
                syncBtnText.innerHTML = '‚è≥ Sincronizando...';
            }
            
            // Atualizar status
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.innerText = '‚è≥ Sincronizando...';
                statusEl.classList.remove('text-green-600', 'text-red-600', 'text-amber-600');
                statusEl.classList.add('text-blue-600');
            }
            
            try {
                // Buscar lista de arquivos JSON do Google Drive
                // Verificar se est√° em modo file://
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    // Em modo file://, n√£o √© poss√≠vel sincronizar devido a CORS
                    // Mas vamos tentar uma abordagem alternativa usando um iframe ou mostrar mensagem clara
                    console.warn('‚ö†Ô∏è Modo file:// detectado. Sincroniza√ß√£o com Google Drive n√£o funciona neste modo.');
                    console.warn('üí° SOLU√á√ÉO OBRIGAT√ìRIA: Use Live Server para sincroniza√ß√£o funcionar:');
                    console.warn('   1. Instale a extens√£o "Live Server" no VS Code');
                    console.warn('   2. Clique com bot√£o direito no index.html ‚Üí "Open with Live Server"');
                    console.warn('   3. O sistema abrir√° em http://localhost e a sincroniza√ß√£o funcionar√°!');
                    
                    // Mostrar alerta visual ao usu√°rio
                    const statusEl = document.getElementById('syncStatus');
                    if (statusEl) {
                        statusEl.innerHTML = '<span class="font-bold">‚ö†Ô∏è USE LIVE SERVER</span><br><span class="text-xs">A sincroniza√ß√£o n√£o funciona em modo file://</span>';
                        statusEl.classList.remove('text-green-600', 'text-blue-600', 'text-amber-600');
                        statusEl.classList.add('text-red-600');
                    }
                    
                    if (syncBtn && syncBtnText) {
                        syncBtnText.innerHTML = '‚ö†Ô∏è Use Live Server';
                        syncBtn.disabled = false;
                    }
                    
                    // Atualizar dashboard com dados locais (se houver)
                    console.log('üí° Atualizando dashboard com dados locais dispon√≠veis (se houver)');
                    console.log(`üìä Dados locais: ${mockDatabase.length} feedback(s)`);
                    updateDashboard();
                    
                    // Mostrar mensagem clara no console e no dashboard
                    console.error('‚ùå ============================================');
                    console.error('‚ùå SINCRONIZA√á√ÉO BLOQUEADA - MODO file://');
                    console.error('‚ùå ============================================');
                    console.error('üìå Para sincronizar com Google Drive, voc√™ DEVE usar Live Server!');
                    console.error('üìå Instru√ß√µes completas est√£o no console acima.');
                    
                    return; // Sair da fun√ß√£o - n√£o tentar sincronizar
                }
                
                const fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folderId: GOOGLE_DRIVE_FOLDER_ID || 'root',
                        action: 'listFiles'
                    })
                };
                
                console.log('üì§ Enviando requisi√ß√£o para listar arquivos...');
                const response = await fetch(syncUrl, fetchOptions);
                
                console.log('üì• Resposta recebida:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì¶ Resultado da sincroniza√ß√£o:', result);
                    console.log(`üìÅ Arquivos encontrados no Google Drive: ${result.files?.length || 0}`);
                    
                    if (result.error) {
                        console.error('‚ùå Erro na resposta:', result.error);
                        throw new Error(result.error);
                    }
                    
                    if (result.files && result.files.length > 0) {
                        let newFilesCount = 0;
                        let skippedFilesCount = 0;
                        
                        // Limpar dados antigos antes de recarregar (garantir sincroniza√ß√£o completa)
                        const existingDriveIds = new Set(jsonFiles.map(f => f.driveId).filter(Boolean));
                        
                        // Priorizar o arquivo √∫nico do banco de dados
                        const databaseFile = result.files.find(f => f.name === 'database_dasco.json');
                        
                        if (databaseFile) {
                            console.log(`üì• Carregando arquivo do banco de dados: ${databaseFile.name} (ID: ${databaseFile.id})`);
                            
                            // SEMPRE recarregar o arquivo do banco de dados para ter os dados mais recentes
                            // Remover vers√£o antiga se existir
                            const existingIndex = jsonFiles.findIndex(f => f.name === 'database_dasco.json');
                            if (existingIndex !== -1) {
                                console.log('üîÑ Removendo vers√£o antiga do banco de dados para recarregar...');
                                jsonFiles.splice(existingIndex, 1);
                            }
                            
                            try {
                                const fileResponse = await fetch(syncUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        fileId: databaseFile.id,
                                        action: 'getFile'
                                    })
                                });
                                
                                if (fileResponse.ok) {
                                    const fileData = await fileResponse.json();
                                    
                                    if (fileData.success && fileData.content) {
                                        try {
                                            const jsonData = JSON.parse(fileData.content);
                                            console.log('üìÑ Conte√∫do bruto do arquivo:', typeof jsonData, Array.isArray(jsonData) ? `Array com ${jsonData.length} itens` : 'Objeto √∫nico');
                                            
                                            // O arquivo do banco de dados sempre √© um array
                                            const feedbacks = Array.isArray(jsonData) ? jsonData : [jsonData];
                                            
                                            console.log(`üìä Processando ${feedbacks.length} feedback(s) do arquivo database_dasco.json`);
                                            
                                            // Log detalhado de cada feedback
                                            feedbacks.forEach((fb, idx) => {
                                                console.log(`  Feedback ${idx + 1}:`, {
                                                    timestamp: fb.timestamp,
                                                    data: fb.data,
                                                    hora: fb.hora,
                                                    cidade: fb.cidade,
                                                    orgulho: fb.orgulho
                                                });
                                            });
                                            
                                            const fileInfo = {
                                                id: Date.now() + Math.random(),
                                                driveId: databaseFile.id,
                                                name: databaseFile.name,
                                                size: databaseFile.sizeBytes || 0,
                                                uploadDate: databaseFile.modifiedTime || new Date().toISOString(),
                                                data: feedbacks // Array completo de feedbacks
                                            };
                                            
                                            // Remover vers√£o antiga do arquivo se existir
                                            const oldFileIndex = jsonFiles.findIndex(f => f.name === 'database_dasco.json');
                                            if (oldFileIndex !== -1) {
                                                console.log('üóëÔ∏è Removendo vers√£o antiga do arquivo do banco de dados');
                                                jsonFiles.splice(oldFileIndex, 1);
                                            }
                                            
                                            jsonFiles.push(fileInfo);
                                            existingDriveIds.add(databaseFile.id);
                                            
                                            // IMPORTANTE: O arquivo database_dasco.json √© a fonte de verdade
                                            // Remover todos os dados antigos do mockDatabase que vieram deste arquivo
                                            // e substituir pelos dados atualizados do arquivo
                                            console.log(`üìä mockDatabase antes: ${mockDatabase.length} itens`);
                                            
                                            // Remover dados antigos que podem ter vindo de vers√µes anteriores do arquivo
                                            // e adicionar TODOS os feedbacks do arquivo (n√£o filtrar por timestamp)
                                            const timestampsFromFile = new Set(feedbacks.map(f => f.timestamp).filter(Boolean));
                                            
                                            // Manter apenas dados que N√ÉO vieram do arquivo (dados locais de pesquisas na mesma sess√£o)
                                            const localData = mockDatabase.filter(d => {
                                                const ts = d.timestamp;
                                                return ts && !timestampsFromFile.has(ts);
                                            });
                                            
                                            // Adicionar TODOS os feedbacks do arquivo
                                            mockDatabase = localData.concat(feedbacks);
                                            
                                            newFilesCount++;
                                            console.log(`‚úÖ Banco de dados carregado completamente!`);
                                            console.log(`   üìÅ Arquivo: ${feedbacks.length} feedback(s)`);
                                            console.log(`   üíæ Dados locais mantidos: ${localData.length}`);
                                            console.log(`   üìä Total no mockDatabase: ${mockDatabase.length}`);
                                        } catch (parseError) {
                                            console.error(`‚ùå Erro ao fazer parse do banco de dados:`, parseError);
                                            console.error('Conte√∫do recebido:', fileData.content?.substring(0, 500));
                                            console.error('Stack:', parseError.stack);
                                        }
                                    } else {
                                        console.error(`‚ùå Erro ao obter conte√∫do do banco de dados:`, fileData.error);
                                        console.error('Resposta completa:', fileData);
                                    }
                                } else {
                                    const errorText = await fileResponse.text();
                                    console.error(`‚ùå Erro HTTP ao buscar banco de dados:`, fileResponse.status, errorText);
                                }
                            } catch (error) {
                                console.error(`‚ùå Erro ao carregar banco de dados:`, error);
                            }
                        } else {
                            console.log('‚ö†Ô∏è Arquivo database_dasco.json n√£o encontrado no Google Drive');
                            console.log('üí° O arquivo ser√° criado quando voc√™ completar a primeira pesquisa');
                        }
                        
                        // Tamb√©m carregar outros arquivos JSON (para compatibilidade com arquivos antigos)
                        for (const file of result.files) {
                            // Pular o arquivo do banco de dados (j√° foi processado)
                            if (file.name === 'database_dasco.json') continue;
                            if (!file.name.endsWith('.json')) {
                                console.log(`‚è≠Ô∏è Arquivo ignorado (n√£o √© JSON): ${file.name}`);
                                continue;
                            }
                            
                            // Verificar se o arquivo j√° foi carregado
                            const alreadyLoaded = existingDriveIds.has(file.id) || jsonFiles.some(f => f.name === file.name && f.driveId === file.id);
                            
                            if (alreadyLoaded) {
                                skippedFilesCount++;
                                console.log(`‚è≠Ô∏è Arquivo j√° carregado: ${file.name}`);
                                continue;
                            }
                            
                            console.log(`üì• Carregando arquivo: ${file.name} (ID: ${file.id})`);
                            
                            // Buscar conte√∫do do arquivo
                            try {
                                const fileResponse = await fetch(syncUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        fileId: file.id,
                                        action: 'getFile'
                                    })
                                });
                                
                                if (fileResponse.ok) {
                                    const fileData = await fileResponse.json();
                                    
                                    if (!fileData.success || !fileData.content) {
                                        console.error(`‚ùå Erro ao obter conte√∫do do arquivo ${file.name}:`, fileData.error);
                                        continue;
                                    }
                                    
                                    try {
                                        const jsonData = JSON.parse(fileData.content);
                                        const fileInfo = {
                                            id: Date.now() + Math.random(),
                                            driveId: file.id,
                                            name: file.name,
                                            size: file.sizeBytes || 0,
                                            uploadDate: file.modifiedTime || new Date().toISOString(),
                                            data: Array.isArray(jsonData) ? jsonData : [jsonData]
                                        };
                                        
                                        jsonFiles.push(fileInfo);
                                        existingDriveIds.add(file.id);
                                        
                                        // Unir TODOS os dados de TODOS os JSONs em um √∫nico resultado
                                        if (Array.isArray(fileInfo.data)) {
                                            mockDatabase = mockDatabase.concat(fileInfo.data);
                                        } else {
                                            mockDatabase.push(fileInfo.data);
                                        }
                                        newFilesCount++;
                                        console.log(`‚úÖ Arquivo ${file.name} carregado com sucesso! ${Array.isArray(fileInfo.data) ? fileInfo.data.length : 1} feedback(s). Total: ${mockDatabase.length}`);
                                    } catch (parseError) {
                                        console.error(`‚ùå Erro ao fazer parse do JSON do arquivo ${file.name}:`, parseError);
                                    }
                                } else {
                                    console.error(`‚ùå Erro ao buscar arquivo ${file.name}:`, fileResponse.status);
                                }
                            } catch (fetchError) {
                                console.error(`‚ùå Erro de rede ao buscar arquivo ${file.name}:`, fetchError);
                            }
                        }
                        
                        console.log(`üìä Resumo da sincroniza√ß√£o: ${newFilesCount} novos arquivos, ${skippedFilesCount} j√° carregados, ${result.files.length} total no Drive`);
                        console.log(`üìä Total de feedbacks no mockDatabase: ${mockDatabase.length}`);
                        
                        // Atualizar status de sucesso
                        if (statusEl) {
                            statusEl.innerText = `‚úÖ ${mockDatabase.length} feedback(s) sincronizado(s)`;
                            statusEl.classList.remove('text-red-600', 'text-amber-600', 'text-blue-600');
                            statusEl.classList.add('text-green-600');
                        }
                        
                        updateJsonFilesList();
                        updateDashboard();
                        
                        if (syncBtn && syncBtnText) {
                            if (newFilesCount > 0) {
                                syncBtnText.innerHTML = `‚úÖ ${newFilesCount} novo(s) arquivo(s)`;
                                setTimeout(() => {
                                    syncBtnText.innerHTML = 'üîÑ Sincronizar Google Drive';
                                }, 3000);
                            } else {
                                syncBtnText.innerHTML = `‚úÖ ${mockDatabase.length} feedback(s)`;
                                setTimeout(() => {
                                    syncBtnText.innerHTML = 'üîÑ Sincronizar Google Drive';
                                }, 2000);
                            }
                        }
                    } else {
                        if (syncBtn && syncBtnText) {
                            syncBtnText.innerHTML = '‚ÑπÔ∏è Nenhum arquivo';
                            setTimeout(() => {
                                syncBtnText.innerHTML = 'üîÑ Sincronizar Google Drive';
                            }, 2000);
                        }
                    }
                } else {
                    // Tentar ler o texto da resposta para mais detalhes
                    let errorMessage = 'Erro ao buscar arquivos';
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage = `Erro HTTP ${response.status}: ${errorText.substring(0, 100)}`;
                        }
                    } catch (e) {
                        errorMessage = `Erro HTTP ${response.status}`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Erro ao sincronizar Google Drive:', error);
                
                // Verificar se √© erro de CORS ou rede
                const isNetworkError = error.message.includes('Failed to fetch') || 
                                     error.message.includes('CORS') ||
                                     error.message.includes('network');
                
                if (isNetworkError) {
                    console.warn('üí° Erro de rede/CORS detectado. Use um servidor local (Live Server) para sincroniza√ß√£o funcionar.');
                }
                
                if (syncBtn && syncBtnText) {
                    syncBtnText.innerHTML = '‚ùå Erro - Verifique console';
                    setTimeout(() => {
                        syncBtnText.innerHTML = 'üîÑ Sincronizar Google Drive';
                    }, 3000);
                }
                
                // Atualizar status
                const statusEl = document.getElementById('syncStatus');
                if (statusEl) {
                    statusEl.innerText = `‚ùå Erro: ${error.message.substring(0, 50)}`;
                    statusEl.classList.remove('text-green-600', 'text-blue-600', 'text-amber-600');
                    statusEl.classList.add('text-red-600');
                }
            } finally {
                if (syncBtn) {
                    syncBtn.disabled = false;
                }
                lastSyncTime = new Date();
            }
        }

        // Sincroniza√ß√£o autom√°tica
        function startAutoSync() {
            // Limpar dados antigos antes de sincronizar
            console.log('üîÑ Iniciando sincroniza√ß√£o autom√°tica...');
            console.log('üóëÔ∏è Limpando dados antigos para recarregar tudo do Google Drive');
            
            // Limpar mockDatabase e jsonFiles para for√ßar recarregamento completo
            mockDatabase = [];
            jsonFiles = [];
            
            // Sincronizar imediatamente ao abrir o dashboard
            if (GOOGLE_DRIVE_SYNC_URL || GOOGLE_APPS_SCRIPT_URL) {
                setTimeout(() => {
                    console.log('üì• For√ßando sincroniza√ß√£o completa do Google Drive...');
                    syncGoogleDrive();
                }, 500);
            }
            
            // Sincronizar automaticamente a cada 30 segundos
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(() => {
                if (GOOGLE_DRIVE_SYNC_URL || GOOGLE_APPS_SCRIPT_URL) {
                    console.log('üîÑ Sincroniza√ß√£o autom√°tica peri√≥dica...');
                    syncGoogleDrive();
                }
            }, 30000); // 30 segundos
        }

        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        function handleJsonUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        const fileData = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: file.size,
                            uploadDate: new Date().toISOString(),
                            data: Array.isArray(jsonData) ? jsonData : [jsonData]
                        };
                        
                        jsonFiles.push(fileData);
                        // Unir TODOS os dados de TODOS os JSONs em um √∫nico resultado
                        if (Array.isArray(fileData.data)) {
                            mockDatabase = mockDatabase.concat(fileData.data);
                        } else {
                            mockDatabase.push(fileData.data);
                        }
                        
                        console.log(`‚úÖ Arquivo ${file.name} carregado manualmente. Total de feedbacks: ${mockDatabase.length}`);
                        updateJsonFilesList();
                        updateDashboard();
                        event.target.value = '';
                    } catch (error) {
                        alert(`Erro ao processar o arquivo ${file.name}: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            });
        }

        function updateJsonFilesList() {
            const listContainer = document.getElementById('jsonFilesList');
            
            if (jsonFiles.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-8 text-slate-400 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-xs font-medium">Nenhum arquivo JSON carregado</p>
                        <p class="text-[10px] mt-1">Os arquivos ser√£o sincronizados automaticamente do Google Drive</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = jsonFiles.map(file => `
                <div class="json-file-item p-4 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-between">
                    <div class="flex items-center space-x-3 flex-1">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#1d438a]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-slate-800 truncate">${file.name}</p>
                            <div class="flex items-center space-x-3 mt-1">
                                <span class="text-[10px] text-slate-500">${(file.size / 1024).toFixed(2)} KB</span>
                                <span class="text-[10px] text-slate-500">‚Ä¢</span>
                                <span class="text-[10px] text-slate-500">${file.data.length} registro(s)</span>
                                <span class="text-[10px] text-slate-500">‚Ä¢</span>
                                <span class="text-[10px] text-slate-500">${new Date(file.uploadDate).toLocaleDateString('pt-BR')}</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteJsonFile('${file.id}')" class="ml-4 p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all" title="Excluir arquivo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function deleteJsonFile(fileId) {
            if (!confirm('Tem certeza que deseja excluir este arquivo JSON?')) return;
            
            const fileIndex = jsonFiles.findIndex(f => f.id == fileId);
            if (fileIndex === -1) return;
            
            const file = jsonFiles[fileIndex];
            mockDatabase = mockDatabase.filter(item => {
                return !file.data.some(fd => JSON.stringify(fd) === JSON.stringify(item));
            });
            
            jsonFiles.splice(fileIndex, 1);
            updateJsonFilesList();
            updateDashboard();
        }

        function addMessage(text, isUser = false, options = null) {
            const div = document.createElement('div');
            div.className = isUser ? "message-user p-4 rounded-2xl max-w-[80%] self-end text-sm shadow-md" : "message-dasco p-4 rounded-2xl max-w-[85%] text-slate-700 text-sm leading-relaxed";
            
            // Substituir [NOME] pelo nome do usu√°rio se existir
            let displayText = text;
            if (userData.nome) {
                displayText = displayText.replace(/\[NOME\]/g, userData.nome);
            }
            
            div.innerHTML = displayText.replace(/\*\*(.*?)\*\*/g, '<b class="text-blue-900">$1</b>');
            chatWindow.appendChild(div);
            
            if (options) {
                const optBox = document.createElement('div');
                optBox.className = "flex flex-wrap gap-2 mt-2";
                options.forEach(opt => {
                    const b = document.createElement('button');
                    b.className = "option-btn px-4 py-2 rounded-xl text-[11px] uppercase tracking-wider";
                    b.innerText = opt;
                    b.onclick = () => processInput(opt);
                    optBox.appendChild(b);
                });
                chatWindow.appendChild(optBox);
            }
            chatWindow.scrollTop = chatWindow.scrollHeight;
            // A voz ser√° chamada pela fun√ß√£o nextStep() explicitamente
        }

        function processInput(val = null) {
            const input = val || userInput.value.trim();
            if(!input) return;

            // PARAR a fala atual imediatamente quando o usu√°rio responder
            window.speechSynthesis.cancel();
            isSpeaking = false;
            
            userInput.value = '';
            addMessage(input, true);
            
            if (input === 'Sim, iniciar nova pesquisa' || input === 'Sim') {
                startNewResearch();
                return;
            }
            if (input === 'N√£o, obrigado' || input === 'N√£o' || input === 'Agora n√£o') {
                addMessage('Entendido. Quando quiser participar, estarei √† disposi√ß√£o. Tenha um excelente trabalho!', false);
                return;
            }

            // Salvar o nome se for o primeiro passo (intro)
            if (dialogue[currentStep].id === 'intro') {
                userData.nome = input;
                userData[dialogue[currentStep].id] = input;
            } else {
                userData[dialogue[currentStep].id] = input;
            }
            
            // Avan√ßar para o pr√≥ximo passo e iniciar a fala imediatamente ap√≥s resposta
            // Input permanece habilitado para permitir escrita durante a fala
            currentStep++;
            console.log(`üìä Passo atual: ${currentStep} de ${dialogue.length} total`);
            
            if (currentStep < dialogue.length) {
                // Mostrar pr√≥xima pergunta imediatamente
                const step = dialogue[currentStep];
                
                // Se for o passo final (tipo "end"), mostrar mensagem e salvar automaticamente
                if (step.type === 'end') {
                    console.log('‚úÖ Passo final detectado! Mostrando mensagem final e salvando...');
                    // Garantir que o nome seja usado na mensagem
                    let finalText = step.text;
                    if (userData.nome) {
                        finalText = finalText.replace(/\[NOME\]/g, userData.nome);
                    }
                    addMessage(finalText, false);
                    
                    // Falar a mensagem final
                    let speakText = step?.speak || step?.text;
                    if (userData.nome) {
                        speakText = speakText.replace(/\[NOME\]/g, userData.nome);
                    }
                    setTimeout(() => {
                        speak(speakText, () => {
                            // Ap√≥s falar a mensagem final, salvar dados
                            console.log('‚úÖ Mensagem final falada. Salvando dados...');
                            // Reduzir tempo de espera para salvar mais r√°pido
                            setTimeout(() => {
                                saveData();
                            }, 200);
                        });
                    }, 100);
                    return;
                }
                
                // Para outros passos, mostrar pergunta normalmente (garantir que nome seja usado)
                let stepText = step.text;
                if (userData.nome) {
                    stepText = stepText.replace(/\[NOME\]/g, userData.nome);
                }
                addMessage(stepText, false, step.options);
                
                // Iniciar a fala imediatamente, sem delay desnecess√°rio
                // Input permanece habilitado - usu√°rio pode responder por escrita a qualquer momento
                let speakText = step?.speak || step?.text;
                if (speakText) {
                    if (userData.nome) {
                        speakText = speakText.replace(/\[NOME\]/g, userData.nome);
                    }
                    // Falar imediatamente ap√≥s mostrar a mensagem
                    // Delay m√≠nimo apenas para garantir renderiza√ß√£o
                    setTimeout(() => {
                        speak(speakText, () => {
                            // Fala terminou - input j√° est√° habilitado
                            console.log('Fala conclu√≠da - input dispon√≠vel para resposta');
                        });
                    }, 30); // Delay m√≠nimo apenas para renderiza√ß√£o
                }
            } else {
                // √öltima pergunta respondida, salvar dados
                console.log('‚úÖ √öltima pergunta respondida! Chamando saveData()...');
                saveData();
            }
        }

        function nextStep() {
            if (currentStep >= dialogue.length) {
                // Se j√° passou do √∫ltimo passo, salvar dados
                console.log('‚úÖ Todos os passos conclu√≠dos! Chamando saveData()...');
                saveData();
                return;
            }
            
            // Input permanece HABILITADO - usu√°rio pode responder por escrita a qualquer momento
            // A voz √© apenas para direcionamento, n√£o bloqueia a pesquisa
            
            const step = dialogue[currentStep];
            console.log(`üìã Mostrando passo ${currentStep + 1}/${dialogue.length}: ${step.id}`);
            
            addMessage(step.text, false, step.options);
            
            // Se for o passo final (tipo "end"), salvar dados ap√≥s mostrar a mensagem
            if (step.type === 'end') {
                console.log('‚úÖ Passo final detectado! Salvando dados...');
                setTimeout(() => {
                    saveData();
                }, 1000); // Aguardar 1 segundo para mostrar a mensagem antes de salvar
                return;
            }
            
            // Iniciar a fala imediatamente, com delay m√≠nimo apenas para renderiza√ß√£o
            setTimeout(() => {
                let speakText = step?.speak || step?.text;
                if (speakText) {
                    if (userData.nome) {
                        speakText = speakText.replace(/\[NOME\]/g, userData.nome);
                    }
                    console.log('Chamando speak() para o passo:', currentStep, 'Texto:', speakText.substring(0, 50));
                    
                    // Falar - input j√° est√° habilitado, usu√°rio pode responder a qualquer momento
                    speak(speakText, () => {
                        // Fala terminou - input j√° est√° dispon√≠vel
                        console.log('Fala conclu√≠da - input dispon√≠vel para resposta');
                    });
                }
            }, 30); // Delay m√≠nimo apenas para garantir renderiza√ß√£o
            
            // Focar no input para facilitar digita√ß√£o
            setTimeout(() => {
                userInput.focus();
            }, 50);
        }

        function startNewResearch() {
            currentStep = 0;
            userData = { timestamp: new Date().toISOString() };
            // Recarregar di√°logo para atualizar sauda√ß√£o e data/hora
            dialogue = getDialogue();
            nextStep();
        }

        async function saveData() {
            console.log('üîµ ============================================');
            console.log('üîµ FUN√á√ÉO saveData() CHAMADA - Iniciando salvamento...');
            console.log('üîµ ============================================');
            try {
                // Adicionar data e hora ao relat√≥rio
                const dateTimeInfo = getDateTimeForReport();
                userData.data = dateTimeInfo.data;
                userData.hora = dateTimeInfo.hora;
                userData.timestamp = dateTimeInfo.timestamp;
                userData.finalizado = true;
                
                console.log('üìù Dados do usu√°rio preparados:', userData);
                
                // Criar c√≥pia sem o nome para o relat√≥rio
                const reportData = {...userData};
                delete reportData.nome; // Remover o nome do relat√≥rio
                
                // Adicionar ao banco de dados local tamb√©m
                mockDatabase.push(reportData);
                
                // Nome do arquivo √∫nico do banco de dados
                const fileName = 'database_dasco.json';
                
                console.log('=== INICIANDO SALVAMENTO ===');
                console.log('Arquivo do banco de dados:', fileName);
                console.log('Novo feedback a ser adicionado:', reportData);
                console.log('Modo:', window.location.protocol === 'file:' ? 'file:// (pode falhar)' : 'http:// (OK)');
                
                // Tentar atualizar o arquivo √∫nico no Google Drive
                console.log('üì§ ============================================');
                console.log('üì§ ATUALIZANDO BANCO DE DADOS NO GOOGLE DRIVE');
                console.log('üì§ ============================================');
                console.log('üîó URL do Script:', GOOGLE_APPS_SCRIPT_URL);
                console.log('üìÅ ID da Pasta:', GOOGLE_DRIVE_FOLDER_ID);
                console.log('üìÑ Arquivo do banco:', fileName);
                
                try {
                    const updateSuccess = await updateDatabaseFile(reportData, fileName);
                    
                    console.log('üì§ Resultado da atualiza√ß√£o:', updateSuccess);
                    
                    if (updateSuccess) {
                        console.log('‚úÖ ============================================');
                        console.log('‚úÖ FEEDBACK ADICIONADO AO BANCO DE DADOS COM SUCESSO!');
                        console.log('‚úÖ ============================================');
                        addMessage('‚úÖ Seu feedback foi registrado com sucesso no banco de dados!', false);
                        
                        // For√ßar atualiza√ß√£o do dashboard se estiver aberto
                        const dashboardView = document.getElementById('dashboardView');
                        if (dashboardView && !dashboardView.classList.contains('hidden')) {
                            console.log('üîÑ Dashboard aberto - for√ßando atualiza√ß√£o...');
                            setTimeout(() => {
                                syncGoogleDrive();
                            }, 2000);
                        }
                    } else {
                        // Se estiver em modo file://, a atualiza√ß√£o pode ter funcionado mesmo retornando false
                        const isFileProtocol = window.location.protocol === 'file:';
                        if (isFileProtocol) {
                            console.log('üí° Modo file:// - atualiza√ß√£o foi tentada, mas n√£o √© poss√≠vel confirmar sucesso');
                            addMessage('üì§ Feedback enviado para o banco de dados! (Verifique a pasta para confirmar)', false);
                        } else {
                            console.warn('‚ö†Ô∏è ============================================');
                            console.warn('‚ö†Ô∏è ATUALIZA√á√ÉO RETORNOU FALSE');
                            console.warn('‚ö†Ô∏è ============================================');
                            addMessage('‚ö†Ô∏è Atualiza√ß√£o pode ter falhado. Verifique a pasta do Google Drive.', false);
                        }
                    }
                } catch (updateError) {
                    // Se estiver em modo file://, o erro pode ser esperado, mas a atualiza√ß√£o pode ter funcionado
                    const isFileProtocol = window.location.protocol === 'file:';
                    if (isFileProtocol) {
                        console.log('üí° Modo file:// - erro esperado, mas atualiza√ß√£o pode ter funcionado');
                        addMessage('üì§ Feedback enviado para o banco de dados! (Verifique a pasta para confirmar)', false);
                        addMessage('üí° Use Live Server para confirmar o sucesso da atualiza√ß√£o.', false);
                    } else {
                        console.error('‚ùå ============================================');
                        console.error('‚ùå ERRO AO ATUALIZAR BANCO DE DADOS');
                        console.error('‚ùå ============================================');
                        console.error('Erro:', updateError);
                        console.error('Stack:', updateError.stack);
                        addMessage('‚ùå Erro ao atualizar banco de dados. Verifique o console (F12) para detalhes.', false);
                    }
                }
                
                // Reduzir tempo de espera para voltar mais r√°pido para pr√≥xima pesquisa
                setTimeout(() => {
                    addMessage('Deseja iniciar uma nova pesquisa?', false, ['Sim, iniciar nova pesquisa', 'N√£o, obrigado']);
                }, 500);
            } catch (error) {
                console.error('‚ùå ============================================');
                console.error('‚ùå ERRO AO SALVAR DADOS');
                console.error('‚ùå ============================================');
                console.error('Erro:', error);
                console.error('Stack trace completo:', error.stack);
                addMessage('‚ùå Erro ao salvar no Google Drive. Verifique o console (F12) e use Live Server para garantir o envio.', false);
                addMessage('üí° Dica: Use Live Server no VS Code para garantir que o upload funcione corretamente.', false);
                
                // N√ÉO salvar localmente - apenas mostrar erro
                // O arquivo DEVE ser salvo apenas no Google Drive
            }
        }

        // Nova fun√ß√£o para atualizar o arquivo √∫nico do banco de dados
        async function updateDatabaseFile(newFeedback, fileName) {
            console.log('üîÑ ============================================');
            console.log('üîÑ ATUALIZANDO BANCO DE DADOS');
            console.log('üîÑ ============================================');
            console.log('üìÑ Arquivo:', fileName);
            console.log('üìù Novo feedback:', newFeedback);
            
            try {
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    console.warn('‚ö†Ô∏è Modo file:// detectado. Tentando atualiza√ß√£o com no-cors...');
                    console.warn('üí° Para garantir a atualiza√ß√£o, use Live Server (http://localhost)');
                }
                
                if (!GOOGLE_APPS_SCRIPT_URL) {
                    throw new Error('Google Apps Script URL n√£o configurada');
                }
                
                if (!GOOGLE_DRIVE_FOLDER_ID) {
                    throw new Error('ID da pasta do Google Drive n√£o configurado');
                }
                
                const payload = {
                    action: 'updateFile',
                    fileName: fileName,
                    newData: newFeedback,
                    folderId: GOOGLE_DRIVE_FOLDER_ID
                };
                
                console.log('üì§ Payload completo:', JSON.stringify(payload, null, 2));
                console.log('üìÅ ID da Pasta:', GOOGLE_DRIVE_FOLDER_ID);
                console.log('üîó URL do Script:', GOOGLE_APPS_SCRIPT_URL);
                console.log('üìã Verificando se o script est√° acess√≠vel...');
                
                // Tentar primeiro com CORS normal (para poder ler a resposta)
                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        redirect: 'follow' // Seguir redirecionamentos do Google Apps Script
                    });
                    
                    console.log('üì° Status da resposta:', response.status, response.statusText);
                    console.log('üì° Response OK?', response.ok);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Resposta completa do servidor:', JSON.stringify(result, null, 2));
                        
                        if (result.success) {
                            console.log(`‚úÖ Banco de dados atualizado com sucesso!`);
                            console.log(`üìÅ Pasta: ${result.folderName || 'N/A'} (ID: ${result.folderId || 'N/A'})`);
                            console.log(`üìÑ Arquivo: ${result.fileName || 'N/A'}`);
                            console.log(`üìä Total de feedbacks: ${result.totalItems || 'N/A'}`);
                            console.log(`üîó URL do arquivo: ${result.fileUrl || 'N/A'}`);
                            console.log(`üîó Link da pasta: https://drive.google.com/drive/folders/${result.folderId || GOOGLE_DRIVE_FOLDER_ID}`);
                            console.log(`üîó Link direto: https://drive.google.com/drive/folders/1cg0SPId-JFv0OqI5dVOCy9ReZBF6TIox`);
                            
                            // Mostrar alerta visual para o usu√°rio
                            alert(`‚úÖ Feedback salvo com sucesso!\n\nüìä Total de feedbacks: ${result.totalItems || 'N/A'}\nüìÅ Pasta: ${result.folderName || 'N/A'}\n\nVerifique a pasta do Google Drive para confirmar.`);
                            
                            return true;
                        } else {
                            console.error('‚ùå Erro na atualiza√ß√£o:', result.error);
                            console.error('üìã Detalhes recebidos:', result);
                            alert(`‚ùå Erro ao salvar: ${result.error || 'Erro desconhecido'}\n\nVerifique o console (F12) para mais detalhes.`);
                            return false;
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Erro HTTP:', response.status);
                        console.error('‚ùå Resposta do servidor:', errorText);
                        try {
                            const errorJson = JSON.parse(errorText);
                            console.error('‚ùå Detalhes do erro:', errorJson);
                            alert(`‚ùå Erro HTTP ${response.status}: ${errorJson.error || errorText}`);
                        } catch (e) {
                            console.error('‚ùå Erro n√£o √© JSON:', errorText);
                            alert(`‚ùå Erro HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                        }
                        return false;
                    }
                } catch (fetchError) {
                    // Se falhar com CORS, tentar com no-cors como fallback
                    console.warn('‚ö†Ô∏è Erro com CORS, tentando no-cors como fallback:', fetchError.message);
                    
                    if (isFileProtocol || fetchError.message.includes('CORS') || fetchError.message.includes('Failed to fetch')) {
                        // Tentar com no-cors (n√£o podemos ler a resposta, mas o arquivo deve ser criado)
                        try {
                            console.log('üì§ Enviando arquivo via no-cors (fallback)...');
                            await fetch(GOOGLE_APPS_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            console.log('‚úÖ Requisi√ß√£o enviada (no-cors mode)');
                            console.log('‚ö†Ô∏è N√£o √© poss√≠vel verificar a resposta em modo no-cors');
                            console.log(`üí° Verifique a pasta: https://drive.google.com/drive/folders/${GOOGLE_DRIVE_FOLDER_ID}`);
                            
                            alert('üì§ Feedback enviado! (modo no-cors - verifique a pasta do Google Drive)\n\nüí° Use Live Server para confirmar o envio.');
                            
                            return true; // Assumir sucesso
                        } catch (noCorsError) {
                            console.error('‚ùå Erro mesmo com no-cors:', noCorsError);
                            throw noCorsError;
                        }
                    } else {
                        throw fetchError;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar banco de dados:', error);
                console.error('Detalhes do erro:', error.message);
                console.error('Stack:', error.stack);
                console.error('URL do Script:', GOOGLE_APPS_SCRIPT_URL);
                console.error('ID da Pasta:', GOOGLE_DRIVE_FOLDER_ID);
                
                const isNetworkError = error.message.includes('Failed to fetch') || 
                                     error.message.includes('CORS') ||
                                     error.message.includes('network');
                
                if (isNetworkError) {
                    console.warn('üí° Erro de rede/CORS detectado. Use um servidor local (Live Server) para atualiza√ß√£o funcionar.');
                    alert('‚ùå Erro de rede/CORS.\n\nüí° Use Live Server (http://localhost) para enviar ao Google Drive.\n\n1. Instale "Live Server" no VS Code\n2. Clique com bot√£o direito no index.html ‚Üí "Open with Live Server"');
                } else {
                    alert(`‚ùå Erro ao enviar: ${error.message}\n\nVerifique o console (F12) para detalhes.`);
                }
                
                return false;
            }
        }


        async function uploadToGoogleDrive(jsonContent, fileName) {
            console.log('üöÄ uploadToGoogleDrive() INICIADA');
            console.log('üìÑ Arquivo:', fileName);
            console.log('üìè Tamanho:', jsonContent.length, 'caracteres');
            
            try {
                // Verificar se est√° em modo file://
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    console.warn('‚ö†Ô∏è Modo file:// detectado. Tentando upload com no-cors...');
                    console.warn('üí° Para garantir o upload, use Live Server (http://localhost)');
                }
                
                if (!GOOGLE_APPS_SCRIPT_URL) {
                    throw new Error('Google Apps Script URL n√£o configurada');
                }
                
                if (!GOOGLE_DRIVE_FOLDER_ID) {
                    throw new Error('ID da pasta do Google Drive n√£o configurado');
                }
                
                console.log('=== INICIANDO UPLOAD PARA GOOGLE DRIVE ===');
                console.log('Arquivo:', fileName);
                console.log('Pasta ID:', GOOGLE_DRIVE_FOLDER_ID);
                console.log('URL do Script:', GOOGLE_APPS_SCRIPT_URL);
                console.log('Tamanho do conte√∫do:', jsonContent.length, 'caracteres');
                console.log('Modo:', isFileProtocol ? 'file:// (pode falhar)' : 'http:// (OK)');
                
                // Validar dados antes de enviar
                if (!fileName || !jsonContent) {
                    throw new Error('Nome do arquivo ou conte√∫do n√£o pode estar vazio');
                }
                
                const payload = {
                    action: 'upload',
                    fileName: fileName,
                    fileContent: jsonContent,
                    folderId: GOOGLE_DRIVE_FOLDER_ID
                };
                
                console.log('=== DADOS DO PAYLOAD ===');
                console.log('A√ß√£o:', payload.action);
                console.log('Nome do arquivo:', fileName);
                console.log('Tamanho do conte√∫do:', jsonContent.length, 'caracteres');
                console.log('ID da pasta:', GOOGLE_DRIVE_FOLDER_ID);
                console.log('URL do Script:', GOOGLE_APPS_SCRIPT_URL);
                console.log('Payload completo (primeiros 200 chars):', JSON.stringify(payload).substring(0, 200) + '...');
                
                // Tentar com CORS primeiro (para poder ler a resposta)
                // Se estiver em file://, pular direto para no-cors
                if (isFileProtocol) {
                    console.log('‚ö†Ô∏è Modo file:// detectado - tentando upload com no-cors...');
                    console.log('üí° Use Live Server para verificar o sucesso do upload');
                    
                    // Tentar com no-cors diretamente (n√£o podemos ler a resposta, mas o arquivo deve ser criado)
                    try {
                        console.log('üì§ Enviando arquivo via no-cors...');
                        await fetch(GOOGLE_APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        console.log('‚úÖ Requisi√ß√£o enviada (no-cors mode)');
                        console.log('‚ö†Ô∏è N√£o √© poss√≠vel verificar a resposta em modo no-cors');
                        console.log('üìÅ Verifique a pasta do Google Drive:', 'https://drive.google.com/drive/folders/' + GOOGLE_DRIVE_FOLDER_ID);
                        console.log('üìã Dados enviados:', {
                            fileName: fileName,
                            folderId: GOOGLE_DRIVE_FOLDER_ID,
                            contentSize: jsonContent.length,
                            url: GOOGLE_APPS_SCRIPT_URL
                        });
                        
                        addMessage('üì§ Arquivo enviado para o Google Drive! (modo local - verifique a pasta). Use Live Server para confirmar o envio.', false);
                        console.log('üí° IMPORTANTE: Para garantir que o upload funcione e verificar o sucesso, use Live Server no VS Code');
                        console.log('üí° O arquivo provavelmente foi enviado, mas n√£o √© poss√≠vel confirmar em modo file://');
                        
                        // Retornar true - o arquivo provavelmente foi enviado
                        // O Google Apps Script processa a requisi√ß√£o mesmo sem poder ler a resposta
                        return true;
                    } catch (noCorsError) {
                        console.error('‚ùå Erro ao enviar com no-cors:', noCorsError);
                        console.error('Detalhes completos:', noCorsError);
                        throw new Error('Falha no upload (no-cors): ' + noCorsError.message);
                    }
                }
                
                // Tentar com CORS normal (modo http://)
                try {
                    console.log('üì§ Tentando upload com CORS normal...');
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        redirect: 'follow' // Seguir redirecionamentos
                    });
                    
                    console.log('Status da resposta:', response.status);
                    console.log('OK?', response.ok);
                    
                    // Verificar se a resposta √© JSON
                    const contentType = response.headers.get('content-type');
                    console.log('Content-Type da resposta:', contentType);
                    
                    if (response.ok) {
                        let result;
                        try {
                            const responseText = await response.text();
                            console.log('Texto da resposta:', responseText);
                            result = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('‚ùå Erro ao fazer parse da resposta JSON:', parseError);
                            throw new Error('Resposta do servidor n√£o √© um JSON v√°lido');
                        }
                        
                        console.log('Resposta do Google Drive:', result);
                        
                        if (result.success) {
                            console.log('‚úÖ SUCESSO! Arquivo criado:', result.fileId);
                            console.log('URL do arquivo:', result.fileUrl);
                            console.log('Nome do arquivo:', result.fileName);
                            addMessage('‚úÖ Seu feedback foi salvo com sucesso no Google Drive!', false);
                            return true;
                        } else {
                            console.error('‚ùå Erro na resposta:', result.error);
                            console.error('Detalhes completos:', result);
                            throw new Error(result.error || 'Erro desconhecido do servidor');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Resposta n√£o OK:', response.status);
                        console.error('Status:', response.status, response.statusText);
                        console.error('Texto do erro:', errorText);
                        throw new Error('Erro HTTP: ' + response.status + ' - ' + errorText.substring(0, 200));
                    }
                } catch (corsError) {
                    // Se falhar com CORS, tentar com no-cors como fallback
                    console.warn('‚ö†Ô∏è Erro com CORS, tentando no-cors como fallback:', corsError.message);
                    console.log('Detalhes do erro:', corsError);
                    
                    // Tentar com no-cors (n√£o podemos ler a resposta, mas o arquivo deve ser criado)
                    try {
                        console.log('üì§ Enviando arquivo via no-cors (fallback)...');
                        await fetch(GOOGLE_APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        console.log('‚úÖ Requisi√ß√£o enviada (no-cors mode - fallback)');
                        console.log('‚ö†Ô∏è N√£o √© poss√≠vel verificar a resposta em modo no-cors');
                        console.log('üìÅ Verifique a pasta do Google Drive:', 'https://drive.google.com/drive/folders/' + GOOGLE_DRIVE_FOLDER_ID);
                        
                        addMessage('‚úÖ Seu feedback foi enviado para o Google Drive! Verifique a pasta.', false);
                        
                        // Retornar true mesmo em no-cors - o arquivo provavelmente foi enviado
                        return true;
                    } catch (noCorsError) {
                        console.error('‚ùå Erro mesmo com no-cors:', noCorsError);
                        console.error('Detalhes completos:', noCorsError);
                        throw new Error('Falha no upload: ' + noCorsError.message);
                    }
                }
                
                // N√ÉO fazer fallback local - arquivo DEVE ser salvo apenas no Google Drive
                console.error('‚ùå Google Drive n√£o configurado. Configure GOOGLE_APPS_SCRIPT_URL e GOOGLE_DRIVE_FOLDER_ID.');
                addMessage('‚ùå Google Drive n√£o configurado. Configure o sistema antes de usar.', false);
                return false;
                
            } catch (error) {
                const isFileProtocol = window.location.protocol === 'file:';
                
                // Se estiver em modo file://, o erro pode ser esperado, mas o upload com no-cors pode ter funcionado
                // N√£o mostrar erro, apenas informar que foi tentado
                if (isFileProtocol && (error.message.includes('no-cors') || error.message.includes('file://'))) {
                    console.log('üí° Modo file:// - upload foi tentado com no-cors');
                    console.log('üí° O arquivo pode ter sido enviado, mas n√£o √© poss√≠vel confirmar');
                    // N√£o mostrar erro - o upload foi tentado
                    return true; // Retornar true para indicar que tentamos enviar
                }
                
                console.error('‚ùå Erro ao salvar arquivo no Google Drive:', error);
                console.error('Detalhes do erro:', error.message);
                console.error('Stack trace:', error.stack);
                console.error('URL do Script:', GOOGLE_APPS_SCRIPT_URL);
                console.error('ID da Pasta:', GOOGLE_DRIVE_FOLDER_ID);
                
                // Verificar se √© erro de CORS ou rede (mas n√£o file://, que j√° foi tratado acima)
                const isNetworkError = error.message.includes('Failed to fetch') || 
                                     error.message.includes('CORS') ||
                                     error.message.includes('network');
                
                if (isNetworkError) {
                    console.warn('üí° Erro de rede/CORS detectado. Use um servidor local (Live Server) para upload funcionar.');
                    addMessage('‚ùå Erro de rede/CORS. Use Live Server (http://localhost) para enviar ao Google Drive.', false);
                    addMessage('üí° Dica: Instale "Live Server" no VS Code e abra o arquivo com "Open with Live Server".', false);
                } else {
                    addMessage('‚ùå Erro ao enviar para Google Drive. Verifique o console (F12) para detalhes.', false);
                }
                
                // N√ÉO fazer fallback local - arquivo DEVE ser salvo apenas no Google Drive
                console.error('‚ùå Upload falhou. Arquivo N√ÉO ser√° salvo localmente.');
                console.error('üí° Use Live Server para garantir que o upload funcione corretamente.');
                
                return false;
            }
        }

        function refreshData() {
            updateDashboard();
            alert('Dados atualizados com sucesso!');
        }

        function updateDashboard() {
            console.log('üîÑ ============================================');
            console.log('üîÑ ATUALIZANDO DASHBOARD');
            console.log('üîÑ ============================================');
            console.log('üìä Estado inicial:', {
                mockDatabaseLength: mockDatabase.length,
                jsonFilesLength: jsonFiles.length
            });
            
            // Log detalhado dos arquivos JSON
            jsonFiles.forEach((file, idx) => {
                const dataCount = Array.isArray(file.data) ? file.data.length : (file.data ? 1 : 0);
                console.log(`  Arquivo ${idx + 1}: ${file.name} - ${dataCount} feedback(s)`);
            });
            
            // Garantir que TODOS os dados de TODOS os JSONs estejam unidos
            // Reunir todos os dados de todos os arquivos JSON
            let allData = [];
            
            // Adicionar dados dos arquivos JSON (priorizar database_dasco.json)
            const databaseFile = jsonFiles.find(f => f.name === 'database_dasco.json');
            const otherFiles = jsonFiles.filter(f => f.name !== 'database_dasco.json');
            
            // Primeiro adicionar o arquivo do banco de dados (fonte de verdade)
            if (databaseFile) {
                if (Array.isArray(databaseFile.data)) {
                    console.log(`üìÅ Adicionando ${databaseFile.data.length} feedback(s) do database_dasco.json`);
                    allData = allData.concat(databaseFile.data);
                } else if (databaseFile.data) {
                    console.log(`üìÅ Adicionando 1 feedback do database_dasco.json`);
                    allData.push(databaseFile.data);
                }
            }
            
            // Depois adicionar outros arquivos JSON (compatibilidade com arquivos antigos)
            otherFiles.forEach(file => {
                if (Array.isArray(file.data)) {
                    console.log(`üìÑ Adicionando ${file.data.length} feedback(s) do arquivo ${file.name}`);
                    allData = allData.concat(file.data);
                } else if (file.data) {
                    console.log(`üìÑ Adicionando 1 feedback do arquivo ${file.name}`);
                    allData.push(file.data);
                }
            });
            
            // Adicionar dados que j√° est√£o em mockDatabase mas que n√£o vieram dos arquivos
            // (dados locais de pesquisas na mesma sess√£o que ainda n√£o foram salvos)
            const fileTimestamps = new Set();
            jsonFiles.forEach(file => {
                const fileData = Array.isArray(file.data) ? file.data : (file.data ? [file.data] : []);
                fileData.forEach(item => {
                    const ts = item.timestamp;
                    if (ts) fileTimestamps.add(ts);
                });
            });
            
            const localOnlyData = mockDatabase.filter(d => {
                const ts = d.timestamp;
                return !ts || !fileTimestamps.has(ts);
            });
            
            if (localOnlyData.length > 0) {
                console.log(`üíæ Adicionando ${localOnlyData.length} feedback(s) locais (n√£o salvos ainda)`);
                allData = allData.concat(localOnlyData);
            }
            
            console.log(`üìä Total de dados coletados: ${allData.length}`);
            
            // Remover duplicatas baseado em timestamp (mais preciso)
            const uniqueData = [];
            const seenTimestamps = new Set();
            const seenCombinations = new Set(); // Para itens sem timestamp
            
            allData.forEach((item, index) => {
                const timestamp = item.timestamp;
                
                if (timestamp) {
                    // Se tem timestamp, usar como chave √∫nica
                    if (!seenTimestamps.has(timestamp)) {
                        seenTimestamps.add(timestamp);
                        uniqueData.push(item);
                    } else {
                        console.log(`‚ö†Ô∏è Duplicata encontrada (timestamp: ${timestamp}) - ignorando`);
                    }
                } else {
                    // Se n√£o tem timestamp, usar combina√ß√£o de campos como chave
                    const key = `${item.data || ''}_${item.hora || ''}_${item.orgulho || ''}_${item.cidade || ''}`;
                    if (!seenCombinations.has(key)) {
                        seenCombinations.add(key);
                        uniqueData.push(item);
                    } else {
                        console.log(`‚ö†Ô∏è Duplicata encontrada (sem timestamp) - ignorando`);
                    }
                }
            });
            
            console.log(`üìä Dados √∫nicos ap√≥s remo√ß√£o de duplicatas: ${uniqueData.length}`);
            
            // Atualizar mockDatabase com todos os dados unidos e √∫nicos
            mockDatabase = uniqueData;
            
            console.log(`‚úÖ mockDatabase atualizado: ${mockDatabase.length} feedback(s) √∫nicos`);
            
            // Aplicar filtro por cidade/contrato se selecionado
            const filterCidade = document.getElementById('filterCidade')?.value || '';
            let dataToUse = uniqueData;
            
            if (filterCidade) {
                dataToUse = uniqueData.filter(item => item.cidade === filterCidade);
                console.log(`üîç Filtro aplicado: ${filterCidade} - ${dataToUse.length} feedbacks`);
            }
            
            console.log('‚úÖ Dashboard atualizado:', {
                totalFeedbacks: dataToUse.length,
                filtro: filterCidade || 'Nenhum',
                dadosUnidos: uniqueData.length
            });
            
            const total = dataToUse.length || 0;
            document.getElementById('totalFeedbacks').innerText = total;
            
            // Calcular n√≠vel de orgulho (usar dados filtrados)
            const orgulhoData = dataToUse.filter(d => d.orgulho).map(d => d.orgulho);
            let pridePercentage = '--';
            if (orgulhoData.length > 0) {
                const prideScores = {
                    'Muito Orgulho üíô': 100,
                    'Orgulho': 75,
                    'Neutro': 50,
                    'Pouco Orgulho': 25
                };
                const avgPride = orgulhoData.reduce((sum, o) => sum + (prideScores[o] || 50), 0) / orgulhoData.length;
                pridePercentage = Math.round(avgPride) + '%';
            }
            document.getElementById('prideScore').innerText = pridePercentage;

            // Calcular status de seguran√ßa (usar dados filtrados)
            const segurancaData = dataToUse.filter(d => d.seguranca).map(d => d.seguranca);
            let safetyStatus = 'OK';
            if (segurancaData.length > 0) {
                const negativas = segurancaData.filter(s => s === 'N√£o' || s === 'Poderia melhorar').length;
                if (negativas > segurancaData.length * 0.3) {
                    safetyStatus = 'ATEN√á√ÉO';
                }
            }
            document.getElementById('safetyAlert').innerText = safetyStatus;

            // Calcular lideran√ßa (usar dados filtrados)
            const liderancaData = dataToUse.filter(d => d.lideranca).map(d => d.lideranca);
            let leadershipScore = '--';
            if (liderancaData.length > 0) {
                const leadershipScores = {
                    'Excelente': 5,
                    'Bom': 4,
                    'Regular': 3,
                    'Insuficiente': 2
                };
                const avgLeadership = liderancaData.reduce((sum, l) => sum + (leadershipScores[l] || 3), 0) / liderancaData.length;
                leadershipScore = avgLeadership.toFixed(1) + '/5';
            }
            document.getElementById('leadershipScore').innerText = leadershipScore;
            
            // Calcular e atualizar novos par√¢metros
            // Sugest√µes de Melhoria
            const suggestionsCount = dataToUse.filter(d => d.melhoria && d.melhoria.trim()).length;
            document.getElementById('suggestionsCount').innerText = suggestionsCount;
            
            // Cidades Ativas
            const cities = new Set(dataToUse.filter(d => d.cidade).map(d => d.cidade));
            const citiesCount = cities.size;
            document.getElementById('citiesCount').innerText = citiesCount;
            
            // Taxa Positiva (orgulho + seguran√ßa + lideran√ßa positivos)
            let positiveCount = 0;
            let totalEvaluations = 0;
            dataToUse.forEach(d => {
                if (d.orgulho && (d.orgulho === 'Muito Orgulho üíô' || d.orgulho === 'Orgulho')) positiveCount++;
                if (d.orgulho) totalEvaluations++;
                if (d.seguranca && (d.seguranca === 'Sim, totalmente' || d.seguranca === 'Na maioria')) positiveCount++;
                if (d.seguranca) totalEvaluations++;
                if (d.lideranca && (d.lideranca === 'Excelente' || d.lideranca === 'Bom')) positiveCount++;
                if (d.lideranca) totalEvaluations++;
            });
            const positiveRate = totalEvaluations > 0 ? Math.round((positiveCount / totalEvaluations) * 100) : 0;
            document.getElementById('positiveRate').innerText = positiveRate + '%';
            
            // √öltima Atualiza√ß√£o
            const lastUpdate = new Date().toLocaleTimeString('pt-BR');
            document.getElementById('lastUpdate').innerText = lastUpdate;
            
            // Anima√ß√µes de progresso
            setTimeout(() => {
                // Progresso do total (baseado em meta de 100)
                const totalProgress = Math.min((total / 100) * 100, 100);
                const totalProgressEl = document.getElementById('totalProgress');
                if (totalProgressEl) {
                    totalProgressEl.style.width = totalProgress + '%';
                }
                
                // Progresso do orgulho
                const pridePercent = pridePercentage !== '--' ? parseInt(pridePercentage) : 0;
                const prideProgressEl = document.getElementById('prideProgress');
                const pridePercentEl = document.getElementById('pridePercent');
                if (prideProgressEl) prideProgressEl.style.width = pridePercent + '%';
                if (pridePercentEl) pridePercentEl.innerText = pridePercentage;
                
                // Progresso da lideran√ßa
                const leadershipNum = leadershipScore !== '--' ? parseFloat(leadershipScore) : 0;
                const leadershipPercent = (leadershipNum / 5) * 100;
                const leadershipProgressEl = document.getElementById('leadershipProgress');
                const leadershipPercentEl = document.getElementById('leadershipPercent');
                if (leadershipProgressEl) leadershipProgressEl.style.width = leadershipPercent + '%';
                if (leadershipPercentEl) leadershipPercentEl.innerText = leadershipScore;
                
                // Percentual de seguran√ßa
                const safetyPercent = segurancaData.length > 0 ? 
                    Math.round((segurancaData.filter(s => s === 'Sim, totalmente' || s === 'Na maioria').length / segurancaData.length) * 100) : 0;
                const safetyPercentEl = document.getElementById('safetyPercent');
                if (safetyPercentEl) safetyPercentEl.innerText = safetyPercent + '% positivo';
            }, 100);

            // Gr√°fico de Engajamento
            const ctx1 = document.getElementById('engagementChart').getContext('2d');
            if(charts.eng) charts.eng.destroy();
            
            const orgulhoCount = orgulhoData.filter(o => o === 'Muito Orgulho üíô' || o === 'Orgulho').length;
            const segurancaCount = segurancaData.filter(s => s === 'Sim, totalmente' || s === 'Na maioria').length;
            const liderancaCount = liderancaData.filter(l => l === 'Excelente' || l === 'Bom').length;
            
            charts.eng = new Chart(ctx1, {
                type: 'doughnut',
                data: { 
                    labels: ['Orgulho', 'Seguran√ßa', 'Lideran√ßa'], 
                    datasets: [{ 
                        data: [orgulhoCount || 0, segurancaCount || 0, liderancaCount || 0], 
                        backgroundColor: ['#1d438a', '#e30613', '#64748b'], 
                        borderWidth: 0, 
                        hoverOffset: 10 
                    }] 
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                usePointStyle: true, 
                                padding: 20, 
                                font: { size: 10, weight: 'bold' } 
                            } 
                        } 
                    }, 
                    cutout: '70%' 
                }
            });

            // Gr√°fico de Lideran√ßa
            const ctx2 = document.getElementById('leadershipChart').getContext('2d');
            if(charts.lead) charts.lead.destroy();
            
            const leadershipScores = {
                'Excelente': 5,
                'Bom': 4,
                'Regular': 3,
                'Insuficiente': 2
            };
            
            const recentLideranca = liderancaData.slice(-10).map(l => leadershipScores[l] || 3);
            while (recentLideranca.length < 10) {
                recentLideranca.unshift(3.5);
            }
            
            charts.lead = new Chart(ctx2, {
                type: 'line',
                data: { 
                    labels: Array.from({length: 10}, (_, i) => `Dia ${i + 1}`), 
                    datasets: [{ 
                        label: 'Performance Lideran√ßa', 
                        data: recentLideranca, 
                        borderColor: '#1d438a', 
                        backgroundColor: 'rgba(29, 67, 138, 0.1)', 
                        fill: true, 
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }] 
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false } 
                    }, 
                    scales: { 
                        y: { 
                            display: false,
                            min: 0,
                            max: 5
                        } 
                    } 
                }
            });

            // Gr√°fico de Distribui√ß√£o
            const ctx3 = document.getElementById('distributionChart').getContext('2d');
            if(charts.dist) charts.dist.destroy();
            
            const orgulhoDist = {
                'Muito Orgulho üíô': orgulhoData.filter(o => o === 'Muito Orgulho üíô').length,
                'Orgulho': orgulhoData.filter(o => o === 'Orgulho').length,
                'Neutro': orgulhoData.filter(o => o === 'Neutro').length,
                'Pouco Orgulho': orgulhoData.filter(o => o === 'Pouco Orgulho').length
            };
            
            charts.dist = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(orgulhoDist),
                    datasets: [{
                        label: 'Quantidade de Respostas',
                        data: Object.values(orgulhoDist),
                        backgroundColor: ['#1d438a', '#3b82f6', '#64748b', '#94a3b8'],
                        borderRadius: 8
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Lista Completa de Participa√ß√µes com TODOS os par√¢metros
            const participacoesList = document.getElementById('participacoesList');
            const participacoesCount = document.getElementById('participacoesCount');
            
            if (participacoesCount) {
                participacoesCount.innerText = `${dataToUse.length} Participa√ß√£o(√µes)`;
            }
            
            if (dataToUse.length === 0) {
                if (participacoesList) {
                    participacoesList.innerHTML = '<div class="text-center py-10"><p class="text-xs italic text-slate-400 font-medium tracking-wide">Nenhuma participa√ß√£o encontrada. Complete pesquisas para ver os dados aqui.</p></div>';
                }
            } else {
                if (participacoesList) {
                    participacoesList.innerHTML = dataToUse.map((feedback, index) => {
                        // Formatar data e hora
                        let dataHora = '';
                        if (feedback.data && feedback.hora) {
                            dataHora = `${feedback.data} √†s ${feedback.hora}`;
                        } else if (feedback.timestamp) {
                            const dt = new Date(feedback.timestamp);
                            dataHora = `${dt.toLocaleDateString('pt-BR')} √†s ${dt.toLocaleTimeString('pt-BR')}`;
                        } else {
                            dataHora = 'Data n√£o dispon√≠vel';
                        }
                        
                        // Criar cards de par√¢metros
                        const parametros = [];
                        
                        if (feedback.orgulho) {
                            parametros.push({ label: 'üíô Orgulho', value: feedback.orgulho, color: 'blue' });
                        }
                        if (feedback.seguranca) {
                            parametros.push({ label: 'üõ°Ô∏è Seguran√ßa', value: feedback.seguranca, color: 'amber' });
                        }
                        if (feedback.lideranca) {
                            parametros.push({ label: '‚≠ê Lideran√ßa', value: feedback.lideranca, color: 'indigo' });
                        }
                        if (feedback.cidade) {
                            parametros.push({ label: 'üèôÔ∏è Cidade', value: feedback.cidade, color: 'purple' });
                        }
                        if (feedback.sigilo) {
                            parametros.push({ label: 'üîí Sigilo', value: feedback.sigilo, color: 'green' });
                        }
                        if (feedback.melhoria && feedback.melhoria.trim()) {
                            parametros.push({ label: 'üí° Sugest√£o', value: feedback.melhoria, color: 'teal' });
                        }
                        
                        return `
                            <div class="p-5 bg-gradient-to-br from-white to-slate-50 rounded-2xl border-2 border-slate-200 shadow-md hover:shadow-xl hover:border-[#1d438a] transition-all duration-300">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-[11px] font-black text-[#1d438a] uppercase bg-blue-50 px-3 py-1 rounded-lg">Participa√ß√£o #${index + 1}</span>
                                            ${feedback.cidade ? `<span class="text-[10px] font-bold text-purple-700 uppercase bg-purple-50 px-2 py-1 rounded">${feedback.cidade}</span>` : ''}
                                        </div>
                                        <p class="text-[10px] text-slate-500 font-medium">üìÖ ${dataHora}</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                                    ${parametros.map(param => {
                                        const colorClasses = {
                                            blue: 'border-blue-200 bg-blue-50',
                                            amber: 'border-amber-200 bg-amber-50',
                                            indigo: 'border-indigo-200 bg-indigo-50',
                                            purple: 'border-purple-200 bg-purple-50',
                                            green: 'border-green-200 bg-green-50',
                                            teal: 'border-teal-200 bg-teal-50'
                                        };
                                        
                                        const bgClass = colorClasses[param.color] || 'border-slate-200 bg-slate-50';
                                        
                                        return `
                                            <div class="p-3 rounded-xl border ${bgClass}">
                                                <p class="text-[9px] font-black text-slate-600 uppercase mb-1">${param.label}</p>
                                                <p class="text-[11px] font-semibold text-slate-800 ${param.label.includes('Sugest√£o') ? 'italic' : ''}">${param.value}</p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // Lista de Sugest√µes (apenas sugest√µes)
            const list = document.getElementById('feedbackList');
            const melhorias = dataToUse.filter(d => d.melhoria && d.melhoria.trim()).map(d => ({
                text: d.melhoria,
                timestamp: d.timestamp || new Date().toISOString(),
                cidade: d.cidade || 'N√£o informado'
            }));
            
            if (melhorias.length === 0) {
                if (list) {
                    list.innerHTML = '<div class="text-center py-10"><p class="text-xs italic text-slate-400 font-medium tracking-wide">Nenhuma sugest√£o de melhoria registrada ainda.</p></div>';
                }
            } else {
                if (list) {
                    list.innerHTML = melhorias.map(m => `
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 text-xs shadow-sm hover:border-blue-200 transition-colors">
                            <div class="flex justify-between mb-2">
                                <span class="text-[9px] font-black text-blue-800 uppercase bg-blue-50 px-2 py-0.5 rounded">üí° Sugest√£o</span>
                                <div class="flex gap-2">
                                    ${m.cidade !== 'N√£o informado' ? `<span class="text-[9px] font-bold text-purple-700 uppercase bg-purple-50 px-2 py-0.5 rounded">${m.cidade}</span>` : ''}
                                    <span class="text-[9px] text-slate-400">${new Date(m.timestamp).toLocaleDateString('pt-BR')}</span>
                                </div>
                            </div>
                            <p class="text-slate-600 font-medium">${m.text}</p>
                        </div>
                    `).join('');
                }
            }
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const lineHeight = 7;
            
            const pageWidth = doc.internal.pageSize.width;
            
            // Cabe√ßalho Moderno - Modelo Dasco
            // Ret√¢ngulo de fundo azul
            doc.setFillColor(29, 67, 138); // #1d438a
            doc.rect(0, 0, pageWidth, 50, 'F');
            
            // Logo/T√≠tulo
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text("DASCO", margin, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text("Excel√™ncia em Saneamento", margin, 35);
            
            // Data e total no canto direito
            doc.setFontSize(10);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth - margin - 50, 25);
            doc.text(`Total: ${mockDatabase.length} feedbacks`, pageWidth - margin - 50, 35);
            
            yPos = 60;
            
            // Linha decorativa
            doc.setDrawColor(29, 67, 138);
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 10;
            
            // T√≠tulo do Relat√≥rio
            doc.setTextColor(29, 67, 138);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Relat√≥rio Consolidado de Feedbacks", margin, yPos);
            yPos += 12;
            
            // Verificar se h√° dados
            if (mockDatabase.length === 0) {
                doc.setFontSize(12);
                doc.setTextColor(150);
                doc.text("Nenhum feedback registrado ainda.", margin, yPos);
                doc.save("Relatorio_Feedback_Dasco.pdf");
                return;
            }
            
            // Mapear IDs das perguntas para t√≠tulos leg√≠veis (TODAS as perguntas)
            const questionLabels = {
                'intro': 'Nome do Funcion√°rio',
                'sigilo': 'Confirma√ß√£o de Sigilo',
                'orgulho': 'N√≠vel de Orgulho',
                'seguranca': 'Condi√ß√µes de Seguran√ßa',
                'lideranca': 'Suporte da Lideran√ßa',
                'melhoria': 'Sugest√£o de Melhoria',
                'data': 'Data',
                'hora': 'Hora',
                'timestamp': 'Timestamp'
            };
            
            // Cards de Estat√≠sticas Visuais
            doc.setFontSize(16);
            doc.setTextColor(29, 67, 138);
            doc.setFont(undefined, 'bold');
            doc.text("üìä Estat√≠sticas Gerais", margin, yPos);
            yPos += 10;
            
            // Calcular estat√≠sticas
            const orgulhoData = mockDatabase.map(f => f.orgulho).filter(Boolean);
            const segurancaData = mockDatabase.map(f => f.seguranca).filter(Boolean);
            const liderancaData = mockDatabase.map(f => f.lideranca).filter(Boolean);
            const melhorias = mockDatabase.map(f => f.melhoria).filter(Boolean);
            const cities = new Set(mockDatabase.filter(f => f.cidade).map(f => f.cidade));
            
            // Box de estat√≠sticas com fundo colorido
            const boxY = yPos;
            doc.setFillColor(240, 245, 255); // Azul muito claro
            doc.roundedRect(margin, boxY - 5, pageWidth - (margin * 2), 80, 3, 3, 'F');
            
            doc.setFontSize(11);
            doc.setTextColor(29, 67, 138);
            doc.setFont(undefined, 'bold');
            
            // Coluna 1
            doc.text(`Total de Feedbacks: ${mockDatabase.length}`, margin + 5, boxY + 5);
            doc.text(`Cidades Ativas: ${cities.size}`, margin + 5, boxY + 12);
            doc.text(`Sugest√µes: ${melhorias.length}`, margin + 5, boxY + 19);
            
            // Coluna 2
            const orgulhoAvg = orgulhoData.length > 0 ? 
                Math.round(orgulhoData.reduce((sum, o) => {
                    const scores = {'Muito Orgulho üíô': 100, 'Orgulho': 75, 'Neutro': 50, 'Pouco Orgulho': 25};
                    return sum + (scores[o] || 50);
                }, 0) / orgulhoData.length) : 0;
            doc.text(`Orgulho M√©dio: ${orgulhoAvg}%`, margin + 100, boxY + 5);
            
            const segurancaPos = segurancaData.length > 0 ? 
                Math.round((segurancaData.filter(s => s === 'Sim, totalmente' || s === 'Na maioria').length / segurancaData.length) * 100) : 0;
            doc.text(`Seguran√ßa: ${segurancaPos}%`, margin + 100, boxY + 12);
            
            const liderancaAvg = liderancaData.length > 0 ? 
                (liderancaData.reduce((sum, l) => {
                    const scores = {'Excelente': 5, 'Bom': 4, 'Regular': 3, 'Insuficiente': 2};
                    return sum + (scores[l] || 3);
                }, 0) / liderancaData.length).toFixed(1) : '0.0';
            doc.text(`Lideran√ßa: ${liderancaAvg}/5.0`, margin + 100, boxY + 19);
            
            yPos = boxY + 90;
            
            // Distribui√ß√£o detalhada
            doc.setFontSize(14);
            doc.setTextColor(29, 67, 138);
            doc.setFont(undefined, 'bold');
            doc.text("üìà Distribui√ß√£o de Respostas", margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.setFont(undefined, 'normal');
            
            if (orgulhoData.length > 0) {
                const orgulhoCounts = {};
                orgulhoData.forEach(o => {
                    orgulhoCounts[o] = (orgulhoCounts[o] || 0) + 1;
                });
                doc.setFont(undefined, 'bold');
                doc.setTextColor(29, 67, 138);
                doc.text("N√≠vel de Orgulho:", margin, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                Object.entries(orgulhoCounts).forEach(([key, value]) => {
                    const percent = Math.round(value/orgulhoData.length*100);
                    // Barra visual
                    const barWidth = (percent / 100) * 50;
                    doc.setFillColor(29, 67, 138);
                    doc.rect(margin + 5, yPos - 3, barWidth, 3, 'F');
                    doc.text(`  ${key}: ${value} (${percent}%)`, margin + 60, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            if (segurancaData.length > 0) {
                const segurancaCounts = {};
                segurancaData.forEach(s => {
                    segurancaCounts[s] = (segurancaCounts[s] || 0) + 1;
                });
                doc.setFont(undefined, 'bold');
                doc.setTextColor(29, 67, 138);
                doc.text("Condi√ß√µes de Seguran√ßa:", margin, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                Object.entries(segurancaCounts).forEach(([key, value]) => {
                    const percent = Math.round(value/segurancaData.length*100);
                    const barWidth = (percent / 100) * 50;
                    doc.setFillColor(29, 67, 138);
                    doc.rect(margin + 5, yPos - 3, barWidth, 3, 'F');
                    doc.text(`  ${key}: ${value} (${percent}%)`, margin + 60, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            if (liderancaData.length > 0) {
                const liderancaCounts = {};
                liderancaData.forEach(l => {
                    liderancaCounts[l] = (liderancaCounts[l] || 0) + 1;
                });
                doc.setFont(undefined, 'bold');
                doc.setTextColor(29, 67, 138);
                doc.text("Suporte da Lideran√ßa:", margin, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                Object.entries(liderancaCounts).forEach(([key, value]) => {
                    const percent = Math.round(value/liderancaData.length*100);
                    const barWidth = (percent / 100) * 50;
                    doc.setFillColor(29, 67, 138);
                    doc.rect(margin + 5, yPos - 3, barWidth, 3, 'F');
                    doc.text(`  ${key}: ${value} (${percent}%)`, margin + 60, yPos);
                    yPos += 5;
                });
                yPos += 3;
            }
            
            // Distribui√ß√£o por Cidade
            if (cities.size > 0) {
                yPos += 5;
                doc.setFontSize(14);
                doc.setTextColor(29, 67, 138);
                doc.setFont(undefined, 'bold');
                doc.text("üèôÔ∏è Distribui√ß√£o por Cidade", margin, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                
                const cityCounts = {};
                mockDatabase.forEach(f => {
                    if (f.cidade) {
                        cityCounts[f.cidade] = (cityCounts[f.cidade] || 0) + 1;
                    }
                });
                
                Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).forEach(([city, count]) => {
                    const percent = Math.round((count / mockDatabase.length) * 100);
                    const barWidth = (percent / 100) * 50;
                    doc.setFillColor(29, 67, 138);
                    doc.rect(margin + 5, yPos - 3, barWidth, 3, 'F');
                    doc.text(`  ${city}: ${count} (${percent}%)`, margin + 60, yPos);
                    yPos += 5;
                });
                yPos += 5;
            }
            
            // Verificar se precisa de nova p√°gina
            if (yPos > pageHeight - 40) {
                doc.addPage();
                // Cabe√ßalho em todas as p√°ginas
                doc.setFillColor(29, 67, 138);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("DASCO - Relat√≥rio de Feedbacks", margin, 20);
                yPos = 40;
            }
            
            // Respostas Detalhadas dos Funcion√°rios
            doc.setFontSize(16);
            doc.setTextColor(29, 67, 138);
            doc.setFont(undefined, 'bold');
            doc.text("üìã Respostas Detalhadas dos Funcion√°rios", margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.setFont(undefined, 'normal');
            
            // Listar cada feedback
            mockDatabase.forEach((feedback, index) => {
                // Verificar se precisa de nova p√°gina
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Box do feedback com fundo
                const feedbackBoxY = yPos;
                
                // T√≠tulo do feedback
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(29, 67, 138);
                doc.text(`Feedback #${index + 1}`, margin + 5, yPos);
                yPos += 6;
                
                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.setFont(undefined, 'normal');
                let dateInfo = '';
                if (feedback.data && feedback.hora) {
                    dateInfo = `Data: ${feedback.data} √†s ${feedback.hora}`;
                } else if (feedback.timestamp) {
                    dateInfo = `Data: ${new Date(feedback.timestamp).toLocaleString('pt-BR')}`;
                }
                if (feedback.cidade) {
                    dateInfo += ` | Cidade: ${feedback.cidade}`;
                }
                if (dateInfo) {
                    doc.text(dateInfo, margin + 5, yPos);
                    yPos += 6;
                }
                
                // Linha separadora
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.2);
                doc.line(margin + 5, yPos, pageWidth - margin - 5, yPos);
                yPos += 5;
                
                // Respostas - TODAS as informa√ß√µes coletadas
                doc.setFontSize(10);
                doc.setTextColor(0);
                
                // Listar TODAS as respostas do feedback
                for (const key in feedback) {
                    // Pular campos t√©cnicos
                    if (key === 'finalizado' || key === 'timestamp') continue;
                    
                    const label = questionLabels[key] || key;
                    let value = feedback[key];
                    
                    // Pular se n√£o houver valor
                    if (!value || value === '') continue;
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`${label}:`, margin, yPos);
                    doc.setFont(undefined, 'normal');
                    
                    // Se for texto longo (melhoria), quebrar em m√∫ltiplas linhas
                    if (key === 'melhoria' && value.length > 50) {
                        yPos += 5;
                        const textLines = doc.splitTextToSize(String(value), 170);
                        textLines.forEach(line => {
                            doc.text(line, margin + 5, yPos);
                            yPos += 5;
                        });
                        yPos += 3;
                    } else {
                        // Texto curto, mostrar na mesma linha
                        const valueText = String(value);
                        if (valueText.length > 60) {
                            // Se for muito longo, quebrar
                            yPos += 5;
                            const textLines = doc.splitTextToSize(valueText, 170);
                            textLines.forEach(line => {
                                doc.text(line, margin + 5, yPos);
                                yPos += 5;
                            });
                            yPos += 3;
                        } else {
                            doc.text(valueText, margin + 50, yPos);
                            yPos += 6;
                        }
                    }
                }
                
                yPos += 5; // Espa√ßo entre feedbacks
            });
            
            // Rodap√©
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`P√°gina ${i} de ${totalPages}`, margin, pageHeight - 10);
                doc.text("Dasco - Excel√™ncia em Saneamento", pageHeight - 50, pageHeight - 10, { align: 'right' });
            }
            
            doc.save("Relatorio_Feedback_Dasco.pdf");
        }

        function exportExcel() {
            if (mockDatabase.length === 0) {
                alert('Nenhum dado dispon√≠vel para exportar.');
                return;
            }
            
            // Preparar dados com labels leg√≠veis para todas as colunas
            const questionLabels = {
                'intro': 'Nome do Funcion√°rio',
                'sigilo': 'Confirma√ß√£o de Sigilo',
                'orgulho': 'N√≠vel de Orgulho',
                'seguranca': 'Condi√ß√µes de Seguran√ßa',
                'lideranca': 'Suporte da Lideran√ßa',
                'melhoria': 'Sugest√£o de Melhoria',
                'data': 'Data',
                'hora': 'Hora',
                'timestamp': 'Timestamp'
            };
            
            // Criar dados formatados com todas as informa√ß√µes
            const formattedData = mockDatabase.map((feedback, index) => {
                const row = {
                    'ID': index + 1,
                    'Data': feedback.data || (feedback.timestamp ? new Date(feedback.timestamp).toLocaleDateString('pt-BR') : ''),
                    'Hora': feedback.hora || (feedback.timestamp ? new Date(feedback.timestamp).toLocaleTimeString('pt-BR') : '')
                };
                
                // Adicionar todas as respostas
                for (const key in feedback) {
                    if (key !== 'data' && key !== 'hora' && key !== 'timestamp' && key !== 'finalizado') {
                        const label = questionLabels[key] || key;
                        row[label] = feedback[key] || '';
                    }
                }
                
                return row;
            });
            
            const ws = XLSX.utils.json_to_sheet(formattedData);
            const wb = XLSX.utils.book_new();
            
            // Ajustar largura das colunas
            const colWidths = [];
            Object.keys(formattedData[0] || {}).forEach(() => {
                colWidths.push({ wch: 25 }); // Largura padr√£o
            });
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, "Dados_Dasco");
            XLSX.writeFile(wb, "Base_Dados_Dasco.xlsx");
        }

        let recognition;
        let isVoiceRecognitionActive = false;
        
        function toggleVoiceRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) {
                alert('Reconhecimento de voz n√£o est√° dispon√≠vel no seu navegador.');
                return;
            }
            
            const micBtn = document.getElementById('micBtn');
            
            // Se j√° est√° ativo, desativar
            if (isVoiceRecognitionActive && recognition) {
                recognition.stop();
                recognition = null;
                isVoiceRecognitionActive = false;
                micBtn.classList.remove('voice-pulse');
                micBtn.classList.remove('bg-red-500');
                micBtn.classList.add('text-slate-400');
                return;
            }
            
            // Ativar reconhecimento de voz cont√≠nuo
            recognition = new SR();
            recognition.lang = 'pt-BR';
            recognition.continuous = true; // Modo cont√≠nuo
            recognition.interimResults = false;
            
            // Indicador visual
            micBtn.classList.add('voice-pulse');
            micBtn.classList.add('bg-red-500');
            micBtn.classList.remove('text-slate-400');
            isVoiceRecognitionActive = true;
            
            recognition.onstart = () => {
                console.log('Reconhecimento de voz ativado');
            };
            
            recognition.onresult = (e) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const transcript = e.results[i][0].transcript;
                    if (e.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Atualizar o campo de texto com o que est√° sendo dito (tanto interim quanto final)
                const currentText = finalTranscript.trim() || interimTranscript;
                if (currentText) {
                    userInput.value = currentText;
                }
                
                // Quando finalizar, processar automaticamente
                if (finalTranscript.trim()) {
                    const finalText = finalTranscript.trim();
                    userInput.value = finalText;
                    // Aguardar um pouco antes de processar para garantir que capturou tudo
                    setTimeout(() => {
                processInput();
                    }, 800);
                }
            };
            
            recognition.onerror = (e) => {
                console.error('Erro no reconhecimento de voz:', e.error);
                if (e.error === 'no-speech') {
                    // Se n√£o houver fala, continua escutando
                    return;
                }
            };
            
            recognition.onend = () => {
                // Se foi parado manualmente, n√£o reiniciar
                if (isVoiceRecognitionActive) {
                    // Reiniciar automaticamente para modo cont√≠nuo
                    try {
            recognition.start();
                    } catch (err) {
                        console.log('Reconhecimento j√° est√° ativo');
                    }
                } else {
                    micBtn.classList.remove('voice-pulse');
                    micBtn.classList.remove('bg-red-500');
                    micBtn.classList.add('text-slate-400');
                }
            };
            
            recognition.start();
        }

        function handleKeyDown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); processInput(); } }
        userInput.addEventListener('keydown', handleKeyDown);
        
        // Marcar intera√ß√£o do usu√°rio para permitir s√≠ntese de voz
        function markUserInteraction() {
            if (!userInteracted) {
                userInteracted = true;
                console.log('Intera√ß√£o do usu√°rio detectada - s√≠ntese de voz agora permitida');
                // Processar fila de fala pendente
                if (speechQueue.length > 0) {
                    const firstItem = speechQueue.shift();
                    setTimeout(() => speak(firstItem.text, firstItem.onEnd), 100);
                } else if (dialogue && dialogue.length > 0 && currentStep === 0) {
                    // Se ainda n√£o falou a primeira mensagem, falar agora
                    const step = dialogue[0];
                    if (step && step.speak) {
                        let speakText = step.speak;
                        if (userData.nome) {
                            speakText = speakText.replace(/\[NOME\]/g, userData.nome);
                        }
                        setTimeout(() => speak(speakText), 100);
                    }
                }
            }
        }
        
        // Detectar qualquer intera√ß√£o do usu√°rio
        document.addEventListener('click', markUserInteraction, { once: true });
        document.addEventListener('keydown', markUserInteraction, { once: true });
        document.addEventListener('touchstart', markUserInteraction, { once: true });

        window.onload = function() {
            // Carregar vozes imediatamente
            loadVoices();
            // Aguardar um pouco para garantir que as vozes foram carregadas
            setTimeout(() => {
                loadVoices(); // Recarregar novamente
                startExperience();
            }, 100);
        };
    </script>
</body>
</html>
